-- DROP FUNCTION artefakt.lok_spk_doziadanie(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_doziadanie(p_doziadanie_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, datum_oznamenia text, datum_predlzenia_lehoty_do text, lehota_do text, pocet_dni_predlzenia bigint, procesny_ukon text, spravny_organ text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        k.spk_konanie_id,
        k.cislo_konania,
        TO_CHAR(d.datum_oznamenia, 'DD.MM.YYYY') AS datum_oznamenia,
        TO_CHAR(d.datum_predlzenia_lehoty_do, 'DD.MM.YYYY') AS datum_predlzenia_lehoty_do,
        TO_CHAR(d.lehota_do, 'DD.MM.YYYY') AS lehota_do,
        d.pocet_dni_predlzenia,
        d.procesny_ukon,
        d.spravny_organ
        --d.zabezpecenie_konania_id
    FROM spk.doziadanie d
    INNER JOIN spk.zabezpecenie_konania zk
        ON d.zabezpecenie_konania_id = zk.zabezpecenie_konania_id 
        AND zk.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON k.spk_konanie_id = zk.spk_konanie_id 
        AND k.transakcia_zrusene_id IS NULL
    WHERE 
        d.transakcia_zrusene_id IS NULL
        AND (p_doziadanie_id IS NULL OR d.doziadanie_id = p_doziadanie_id);
END $function$
;

-- DROP FUNCTION artefakt.lok_spk_doziadanie_na_vedomie_zucastneny_subjekt(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_doziadanie_na_vedomie_zucastneny_subjekt(p_doziadanie_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, zucastneny_subjekt_nazov text, zucastneny_subjekt_rola text, zucastneny_subjekt_druh_subjektu text, adresa_typ_adresy text, adresa_obec text, adresa_ulica text, adresa_supisne_cislo text, adresa_orientacne_cislo text, adresa_psc text, adresa_stat text, adresa_subjektu text, ico text, ico_txt text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT DISTINCT
        k.spk_konanie_id,
        u.zucastneny_subjekt_nazov::text,
        u.zucastneny_subjekt_rola,
        u.zucastneny_subjekt_druh_subjektu::text,
        u.adresa_typ_adresy::text,
        u.adresa_obec::text,
        u.adresa_ulica::text,
        u.adresa_supisne_cislo::text,
        u.adresa_orientacne_cislo::text,
        u.adresa_psc::text,
        u.adresa_stat::text,
        u.adresa_subjektu::text,
        u.ico::text,
        'IČO: ' || COALESCE(u.ico::text, '') as ico_txt
    FROM spk.doziadanie d
    INNER JOIN spk.zabezpecenie_konania zk
        ON d.zabezpecenie_konania_id = zk.zabezpecenie_konania_id
        AND zk.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON zk.spk_konanie_id = k.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN ksed.na_vedomie_zucastneny_subjekt nv
        ON nv.zabezpecenie_konania_id = d.zabezpecenie_konania_id
        AND nv.transakcia_zrusene_id IS NULL
    INNER JOIN artefakt.uni_zucastneny_subjekt u
        ON u.zucastneny_subjekt_id = nv.zucastneny_subjekt_id
    WHERE d.transakcia_zrusene_id IS NULL
      AND (p_doziadanie_id IS NULL OR d.doziadanie_id = p_doziadanie_id)
    ORDER BY k.spk_konanie_id;
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_doziadanie_zabezpecenie_konania(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_doziadanie_zabezpecenie_konania(p_doziadanie_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, doziadanie_id bigint, procesny_ukon_nazov text, procesny_ukon_popis text, znenie text, datum_zrusenia text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT
        k.spk_konanie_id,
        k.cislo_konania,
        d.doziadanie_id,
        zk.procesny_ukon_nazov,
        zk.procesny_ukon_popis,
        zk.znenie,
        TO_CHAR(zk.datum_zrusenia, 'DD.MM.YYYY')
    FROM spk.zabezpecenie_konania zk
    INNER JOIN spk.spk_konanie k ON k.spk_konanie_id = zk.spk_konanie_id AND k.transakcia_zrusene_id IS NULL
    INNER JOIN spk.doziadanie d ON d.zabezpecenie_konania_id = zk.zabezpecenie_konania_id AND d.transakcia_zrusene_id IS NULL
    WHERE zk.transakcia_zrusene_id IS NULL
      AND (p_doziadanie_id IS NULL OR d.doziadanie_id = p_doziadanie_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_doziadanie_zucastneny_subjekt(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_doziadanie_zucastneny_subjekt(p_doziadanie_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, zucastneny_subjekt_nazov text, zucastneny_subjekt_rola text, zucastneny_subjekt_druh_subjektu text, adresa_typ_adresy text, adresa_obec text, adresa_ulica text, adresa_supisne_cislo text, adresa_orientacne_cislo text, adresa_psc text, adresa_stat text, adresa_subjektu text, ico text, ico_txt text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT DISTINCT
        k.spk_konanie_id,
        u.zucastneny_subjekt_nazov::text,
        u.zucastneny_subjekt_rola,
        u.zucastneny_subjekt_druh_subjektu::text,
        u.adresa_typ_adresy::text,
        u.adresa_obec::text,
        u.adresa_ulica::text,
        u.adresa_supisne_cislo::text,
        u.adresa_orientacne_cislo::text,
        u.adresa_psc::text,
        u.adresa_stat::text,
        u.adresa_subjektu::text,
        u.ico::text,
        'IČO: ' || COALESCE(u.ico::text, '') as ico_txt
    FROM spk.doziadanie d
    INNER JOIN spk.zabezpecenie_konania zk
        ON d.zabezpecenie_konania_id = zk.zabezpecenie_konania_id
        AND zk.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON zk.spk_konanie_id = k.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN artefakt.uni_zucastneny_subjekt u
        ON u.zucastneny_subjekt_id = zk.zucastneny_subjekt_id
    WHERE d.transakcia_zrusene_id IS NULL
      AND (p_doziadanie_id IS NULL OR d.doziadanie_id = p_doziadanie_id)
    ORDER BY k.spk_konanie_id;
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_odvolanie_v_rozh(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_odvolanie_v_rozh(p_odvolanie_voci_rozhodnutiu_id bigint)
 RETURNS TABLE(odvolanie_voci_rozhodnutiu_id bigint, datum_pod_navrhu_na_mimo_odv_kon text, datum_pod_navrhu_na_obnovu_kon text, datum_prijatia_odvolania text, datum_rozhodnutia_o_odvolani text, datum_upovedomenia_o_odvolani text, vylucenie_odkladneho_ucinku text, cislo_rozhodnutia character varying, sposob_rozhodnutia_kod text, sposob_rozhodnutia_nazov text, typ_odvolania_kod text, typ_odvolania_nazov text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        ov.odvolanie_voci_rozhodnutiu_id,
        TO_CHAR(ov.datum_podania_navrhu_na_mimo_odvolacie_konanie, 'DD.MM.YYYY'),
        TO_CHAR(ov.datum_podania_navrhu_na_obnovu_konania, 'DD.MM.YYYY'),
        TO_CHAR(ov.datum_prijatia_odvolania, 'DD.MM.YYYY'),
        TO_CHAR(ov.datum_rozhodnutia_o_odvolani, 'DD.MM.YYYY'),
        TO_CHAR(ov.datum_upovedomenia_o_odvolani, 'DD.MM.YYYY'),
        CASE WHEN ov.vylucenie_odkladneho_ucinku THEN 'áno' ELSE 'nie' END,
        r.cislo_rozhodnutia,
        csr.kod,
        csr.nazov,
        cto.kod,
        cto.nazov
    FROM 
        spk.odvolanie_voci_rozhodnutiu ov
    INNER JOIN 
        spk.rozhodnutie r ON ov.rozhodnutie_id = r.rozhodnutie_id AND r.transakcia_zrusene_id IS NULL
    INNER JOIN 
        spk.spk_konanie k ON r.spk_konanie_id = k.spk_konanie_id AND k.transakcia_zrusene_id IS NULL
    LEFT JOIN 
        cis.cis_sposob_rozhodnutia_v_odvolacom_konani csr ON ov.cis_sposob_rozhodnutia_v_odvolacom_konani_id = csr.cis_sposob_rozhodnutia_v_odvolacom_konani_id AND csr.transakcia_zrusene_id IS NULL
    LEFT JOIN 
        cis.cis_typ_odvolania cto ON ov.cis_typ_odvolania_id = cto.cis_typ_odvolania_id AND cto.transakcia_zrusene_id IS NULL
    WHERE 
        ov.transakcia_zrusene_id IS NULL
        AND (p_odvolanie_voci_rozhodnutiu_id IS NULL OR ov.odvolanie_voci_rozhodnutiu_id = p_odvolanie_voci_rozhodnutiu_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_odvolanie_v_rozh_rozhodnutie(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_odvolanie_v_rozh_rozhodnutie(p_odvolanie_voci_rozhodnutiu_id bigint)
 RETURNS TABLE(cislo_rozhodnutia character varying, datum_dorucenia_rozhodnutia text, datum_pravoplatnosti text, datum_vykonatelnosti text, datum_vystavenia text, datum_zrusenia_rozhodnutia text, dorucenie_verejnou_vyhlaskou text, navrh_rozhodnutia text, popis_rozhodnutia text, poucenie text, rozhodnutie_v_ramci_obnovy_konania text, vyrok text, odovodnenie text, povolene_odvolanie text, rozhodnutie_v_odvolani text, typ_rozhodnutia_kod text, typ_rozhodnutia_nazov text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        r.cislo_rozhodnutia,
        TO_CHAR(r.datum_dorucenia_rozhodnutia, 'DD.MM.YYYY') AS datum_dorucenia_rozhodnutia,
        TO_CHAR(r.datum_pravoplatnosti, 'DD.MM.YYYY') AS datum_pravoplatnosti,
        TO_CHAR(r.datum_vykonatelnosti, 'DD.MM.YYYY') AS datum_vykonatelnosti,
        TO_CHAR(r.datum_vystavenia, 'DD.MM.YYYY') AS datum_vystavenia,
        TO_CHAR(r.datum_zrusenia_rozhodnutia, 'DD.MM.YYYY') AS datum_zrusenia_rozhodnutia,
        CASE WHEN r.dorucenie_verejnou_vyhlaskou THEN 'áno' ELSE 'nie' END AS dorucenie_verejnou_vyhlaskou,
        CASE WHEN r.navrh_rozhodnutia THEN 'áno' ELSE 'nie' END AS navrh_rozhodnutia,
        r.popis_rozhodnutia,
        r.poucenie,
        CASE WHEN r.rozhodnutie_v_ramci_obnovy_konania THEN 'áno' ELSE 'nie' END AS rozhodnutie_v_ramci_obnovy_konania,
        r.vyrok,
        r.odovodnenie,
        CASE WHEN r.povolene_odvolanie THEN 'áno' ELSE 'nie' END AS povolene_odvolanie,
        CASE WHEN r.rozhodnutie_v_odvolani THEN 'áno' ELSE 'nie' END AS rozhodnutie_v_odvolani,
        ctr.kod AS typ_rozhodnutia_kod,
        ctr.nazov AS typ_rozhodnutia_nazov
    FROM spk.odvolanie_voci_rozhodnutiu ovr
    JOIN spk.rozhodnutie r
        ON r.rozhodnutie_id = ovr.rozhodnutie_id
        AND r.transakcia_zrusene_id IS NULL
    LEFT JOIN spk.spk_konanie k
        ON k.spk_konanie_id = r.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    LEFT JOIN cis.cis_typ_rozhodnutia ctr
        ON r.cis_typ_rozhodnutia_id = ctr.cis_typ_rozhodnutia_id
        AND ctr.transakcia_zrusene_id IS NULL
    WHERE ovr.transakcia_zrusene_id IS NULL
      AND (p_odvolanie_voci_rozhodnutiu_id IS NULL OR ovr.odvolanie_voci_rozhodnutiu_id = p_odvolanie_voci_rozhodnutiu_id);
END $function$
;

-- DROP FUNCTION artefakt.lok_spk_odvolanie_v_rozh_rozhodnutie_prerusenie_konania(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_odvolanie_v_rozh_rozhodnutie_prerusenie_konania(p_odvolanie_voci_rozhodnutiu_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(datum_ukoncenia_preruseni text, doba_prerusenia bigint, iny_dovod_prerusenia text, prerusenie_do text, prerusenie_od text, dovod_prerusenia_kod text, dovod_prerusenia_nazov text, dovod_ukoncenia_kod text, dovod_ukoncenia_nazov text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT
        TO_CHAR(pk.datum_ukoncenia_preruseni, 'DD.MM.YYYY') AS datum_ukoncenia_preruseni,
        pk.doba_prerusenia,
        pk.iny_dovod_prerusenia,
        TO_CHAR(pk.prerusenie_do, 'DD.MM.YYYY') AS prerusenie_do,
        TO_CHAR(pk.prerusenie_od, 'DD.MM.YYYY') AS prerusenie_od,
        cdp.kod AS dovod_prerusenia_kod,
        cdp.nazov AS dovod_prerusenia_nazov,
        cdu.kod AS dovod_ukoncenia_kod,
        cdu.nazov AS dovod_ukoncenia_nazov
    FROM spk.odvolanie_voci_rozhodnutiu ovr
    JOIN spk.rozhodnutie r
        ON r.rozhodnutie_id = ovr.rozhodnutie_id
        AND r.transakcia_zrusene_id IS NULL
    JOIN spk.prerusenie_konania pk
        ON pk.rozhodnutie_id = r.rozhodnutie_id
        AND pk.transakcia_zrusene_id IS NULL
    LEFT JOIN cis.cis_dovod_prerusenia_konania cdp
        ON cdp.cis_dovod_prerusenia_konania_id = pk.cis_dovod_prerusenia_id
        AND cdp.transakcia_zrusene_id IS NULL
    LEFT JOIN cis.cis_dovod_ukoncenia_prerusenia cdu
        ON cdu.cis_dovod_ukoncenia_prerusenia_id = pk.cis_dovod_ukoncenia_id
        AND cdu.transakcia_zrusene_id IS NULL
    WHERE
        ovr.transakcia_zrusene_id IS NULL
        AND (p_odvolanie_voci_rozhodnutiu_id IS NULL OR ovr.odvolanie_voci_rozhodnutiu_id = p_odvolanie_voci_rozhodnutiu_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_odvolanie_v_rozh_rozhodnutie_sankcia_opatrenie(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_odvolanie_v_rozh_rozhodnutie_sankcia_opatrenie(p_odvolanie_voci_rozhodnutiu_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, rozhodnutie_id bigint, cislo_rozhodnutia character varying, specificky_symbol text, variabilny_symbol text, vyska_sankcie numeric, sankcia_opatrenie text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        k.spk_konanie_id,
        k.cislo_konania,
        r.rozhodnutie_id,
        r.cislo_rozhodnutia,
        sor.specificky_symbol,
        sor.variabilny_symbol,
        sor.vyska_sankcie,
        cso.nazov AS sankcia_opatrenie
    FROM spk.odvolanie_voci_rozhodnutiu ovr
    JOIN spk.rozhodnutie r
        ON r.rozhodnutie_id = ovr.rozhodnutie_id
        AND r.transakcia_zrusene_id IS NULL
    INNER JOIN spk.sankcia_opatrenie_v_rozhodnuti sor
        ON sor.rozhodnutie_id = r.rozhodnutie_id
        AND sor.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON r.spk_konanie_id = k.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN cis.cis_sankcia_opatrenie cso
        ON sor.cis_sankcia_opatrenie_id = cso.cis_sankcia_opatrenie_id
        AND cso.transakcia_zrusene_id IS NULL
    WHERE ovr.transakcia_zrusene_id IS NULL
      AND (p_odvolanie_voci_rozhodnutiu_id IS NULL OR ovr.odvolanie_voci_rozhodnutiu_id = p_odvolanie_voci_rozhodnutiu_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_odvolanie_v_rozh_rozhodnutie_sankcia_skutkova_pod(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_odvolanie_v_rozh_rozhodnutie_sankcia_skutkova_pod(p_odvolanie_voci_rozhodnutiu_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, rozhodnutie_id bigint, cislo_rozhodnutia character varying, zistenie text, skutkova_podstata text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        k.spk_konanie_id,
        k.cislo_konania,
        r.rozhodnutie_id,
        r.cislo_rozhodnutia,
        spvr.zistenie,
        csp.nazov AS skutkova_podstata
    FROM spk.odvolanie_voci_rozhodnutiu ovr
    JOIN spk.rozhodnutie r
        ON r.rozhodnutie_id = ovr.rozhodnutie_id
        AND r.transakcia_zrusene_id IS NULL
    INNER JOIN spk.sankcia_opatrenie_v_rozhodnuti sor
        ON sor.rozhodnutie_id = r.rozhodnutie_id
        AND sor.transakcia_zrusene_id IS NULL
    INNER JOIN spk.skutkova_podstata_v_rozhodnuti spvr
        ON spvr.sankcia_opatrenie_v_rozhodnuti_id = sor.sankcia_opatrenie_v_rozhodnuti_id
        AND spvr.transakcia_zrusene_id IS NULL
    INNER JOIN cis.cis_skutkova_podstata csp
        ON spvr.cis_skutkova_podstata_id = csp.cis_skutkova_podstata_id
        AND csp.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON r.spk_konanie_id = k.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    WHERE ovr.transakcia_zrusene_id IS NULL
      AND (p_odvolanie_voci_rozhodnutiu_id IS NULL OR ovr.odvolanie_voci_rozhodnutiu_id = p_odvolanie_voci_rozhodnutiu_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_odvolanie_v_rozh_rozhodnutie_sankcia_skutkova_pod_sank(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_odvolanie_v_rozh_rozhodnutie_sankcia_skutkova_pod_sank(p_odvolanie_voci_rozhodnutiu_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, rozhodnutie_id bigint, cislo_rozhodnutia character varying, specificky_symbol text, variabilny_symbol text, vyska_sankcie_pokuty numeric)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        k.spk_konanie_id,
        k.cislo_konania,
        r.rozhodnutie_id,
        r.cislo_rozhodnutia,
        sp.specificky_symbol,
        sp.variabilny_symbol,
        sp.vyska_sankcie_pokuty
    FROM spk.odvolanie_voci_rozhodnutiu ovr
    JOIN spk.rozhodnutie r
        ON r.rozhodnutie_id = ovr.rozhodnutie_id
        AND r.transakcia_zrusene_id IS NULL
    INNER JOIN spk.sankcia_opatrenie_v_rozhodnuti sor
        ON sor.rozhodnutie_id = r.rozhodnutie_id
        AND sor.transakcia_zrusene_id IS NULL
    INNER JOIN spk.skutkova_podstata_v_rozhodnuti svr
        ON svr.sankcia_opatrenie_v_rozhodnuti_id = sor.sankcia_opatrenie_v_rozhodnuti_id
        AND svr.transakcia_zrusene_id IS NULL
    INNER JOIN spk.sankcia_pokuta sp
        ON sp.skutkova_podstata_v_rozhodnuti_id = svr.skutkova_podstata_v_rozhodnuti_id
        AND sp.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON r.spk_konanie_id = k.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    WHERE ovr.transakcia_zrusene_id IS NULL
      AND (p_odvolanie_voci_rozhodnutiu_id IS NULL OR ovr.odvolanie_voci_rozhodnutiu_id = p_odvolanie_voci_rozhodnutiu_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_odvolanie_v_rozh_rozhodnutie_skutkova_pod_sankcia_pokut(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_odvolanie_v_rozh_rozhodnutie_skutkova_pod_sankcia_pokut(p_odvolanie_voci_rozhodnutiu_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, rozhodnutie_id bigint, cislo_rozhodnutia character varying, specificky_symbol text, variabilny_symbol text, vyska_sankcie_pokuty numeric)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        k.spk_konanie_id,
        k.cislo_konania,
        r.rozhodnutie_id,
        r.cislo_rozhodnutia,
        sp.specificky_symbol,
        sp.variabilny_symbol,
        sp.vyska_sankcie_pokuty
    FROM spk.odvolanie_voci_rozhodnutiu ovr
    JOIN spk.rozhodnutie r
        ON r.rozhodnutie_id = ovr.rozhodnutie_id
        AND r.transakcia_zrusene_id IS NULL
    INNER JOIN spk.skutkova_podstata_v_rozhodnuti svr
        ON svr.rozhodnutie_id = r.rozhodnutie_id
        AND svr.transakcia_zrusene_id IS NULL
    INNER JOIN spk.sankcia_pokuta sp
        ON sp.skutkova_podstata_v_rozhodnuti_id = svr.skutkova_podstata_v_rozhodnuti_id
        AND sp.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON r.spk_konanie_id = k.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    WHERE ovr.transakcia_zrusene_id IS NULL
      AND (p_odvolanie_voci_rozhodnutiu_id IS NULL OR ovr.odvolanie_voci_rozhodnutiu_id = p_odvolanie_voci_rozhodnutiu_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_odvolanie_v_rozh_rozhodnutie_skutkova_podstata(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_odvolanie_v_rozh_rozhodnutie_skutkova_podstata(p_odvolanie_voci_rozhodnutiu_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, rozhodnutie_id bigint, cislo_rozhodnutia character varying, zistenie text, skutkova_podstata text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        k.spk_konanie_id,
        k.cislo_konania,
        r.rozhodnutie_id,
        r.cislo_rozhodnutia,
        spvr.zistenie,
        csp.nazov AS skutkova_podstata
    FROM spk.odvolanie_voci_rozhodnutiu ovr
    JOIN spk.rozhodnutie r
        ON r.rozhodnutie_id = ovr.rozhodnutie_id
        AND r.transakcia_zrusene_id IS NULL
    INNER JOIN spk.skutkova_podstata_v_rozhodnuti spvr
        ON spvr.rozhodnutie_id = r.rozhodnutie_id
        AND spvr.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON r.spk_konanie_id = k.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN cis.cis_skutkova_podstata csp
        ON spvr.cis_skutkova_podstata_id = csp.cis_skutkova_podstata_id
        AND csp.transakcia_zrusene_id IS NULL
    WHERE ovr.transakcia_zrusene_id IS NULL
      AND (p_odvolanie_voci_rozhodnutiu_id IS NULL OR ovr.odvolanie_voci_rozhodnutiu_id = p_odvolanie_voci_rozhodnutiu_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_odvolanie_v_rozh_rozhodnutie_trovy_konania(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_odvolanie_v_rozh_rozhodnutie_trovy_konania(p_odvolanie_voci_rozhodnutiu_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, cislo_rozhodnutia_o_trovach_konania text, datum_predpisania_trov text, vyska_trov_kod text, vyska_trov_nazov text, popis text, cislo_rozhodnutia text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT
        k.spk_konanie_id,
        k.cislo_konania,
        tk.cislo_rozhodnutia_o_trovach_konania,
        TO_CHAR(tk.datum_predpisania_trov, 'DD.MM.YYYY') AS datum_predpisania_trov,
        vt.kod,
        vt.nazov,
        tk.popis,
        r.cislo_rozhodnutia::text
    FROM spk.odvolanie_voci_rozhodnutiu ovr
    JOIN spk.rozhodnutie r
        ON r.rozhodnutie_id = ovr.rozhodnutie_id
        AND r.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON k.spk_konanie_id = r.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN spk.trovy_konania tk
        ON r.rozhodnutie_id = tk.rozhodnutie_id 
        AND tk.transakcia_zrusene_id IS NULL
    INNER JOIN cis.cis_vyska_trov_konania vt
        ON vt.cis_vyska_trov_konania_id = tk.cis_vyska_trov_konania_id
        AND vt.transakcia_zrusene_id IS NULL
    WHERE ovr.transakcia_zrusene_id IS NULL
      AND (p_odvolanie_voci_rozhodnutiu_id IS NULL OR ovr.odvolanie_voci_rozhodnutiu_id = p_odvolanie_voci_rozhodnutiu_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_odvolanie_v_rozh_rozhodnutie_zucastneny_subjekt(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_odvolanie_v_rozh_rozhodnutie_zucastneny_subjekt(p_odvolanie_voci_rozhodnutiu_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, zucastneny_subjekt_nazov text, zucastneny_subjekt_rola text, zucastneny_subjekt_druh_subjektu text, adresa_typ_adresy text, adresa_obec text, adresa_ulica text, adresa_supisne_cislo text, adresa_orientacne_cislo text, adresa_psc text, adresa_stat text, adresa_subjektu text, ico text, ico_txt text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT DISTINCT
        usk.spk_konanie_id,
        usk.zucastneny_subjekt_nazov::text,
        usk.zucastneny_subjekt_rola,
        usk.zucastneny_subjekt_druh_subjektu::text,
        usk.adresa_typ_adresy::text,
        usk.adresa_obec::text,
        usk.adresa_ulica::text,
        usk.adresa_supisne_cislo::text,
        usk.adresa_orientacne_cislo::text,
        usk.adresa_psc::text,
        usk.adresa_stat::text,
        usk.adresa_subjektu::text,
        usk.ico::text,
        'IČO: ' || COALESCE(usk.ico::text, '') AS ico_txt
    FROM spk.odvolanie_voci_rozhodnutiu ovr
    JOIN spk.rozhodnutie r
        ON r.rozhodnutie_id = ovr.rozhodnutie_id
        AND r.transakcia_zrusene_id IS NULL
    JOIN spk.rozhodnutie_zucastneny_subjekt rz
        ON rz.rozhodnutie_id = r.rozhodnutie_id
    JOIN artefakt.uni_zucastneny_subjekt usk
        ON rz.zucastneny_subjekt_id = usk.zucastneny_subjekt_id
    WHERE ovr.transakcia_zrusene_id IS NULL
      AND (p_odvolanie_voci_rozhodnutiu_id IS NULL OR ovr.odvolanie_voci_rozhodnutiu_id = p_odvolanie_voci_rozhodnutiu_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_odvolanie_v_rozh_vstupny_dokument(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_odvolanie_v_rozh_vstupny_dokument(p_odvolanie_voci_rozhodnutiu_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, rozhodnutie_id bigint, cislo_rozhodnutia character varying, dokument_nazov text, typ_vstupneho_dokumentu text, priloha_nazov_suboru text, datum_vytvorenia text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        spk_konanie.spk_konanie_id,
        spk_konanie.cislo_konania,
        rozhodnutie.rozhodnutie_id,
        rozhodnutie.cislo_rozhodnutia,
        dokument.nazov,
        cis_typ_vstupneho_artefaktu.nazov,
        priloha.nazov_suboru,
        TO_CHAR(dokument.datum_vytvorenia, 'DD.MM.YYYY')
    FROM spk.odvolanie_voci_rozhodnutiu
    JOIN spk.odvolanie_voci_rozhodnutiu_vstupny_dokument 
        ON odvolanie_voci_rozhodnutiu_vstupny_dokument.odvolanie_voci_rozhodnutiu_id = odvolanie_voci_rozhodnutiu.odvolanie_voci_rozhodnutiu_id
        AND odvolanie_voci_rozhodnutiu_vstupny_dokument.transakcia_zrusene_id IS NULL
    JOIN spk.rozhodnutie 
        ON rozhodnutie.rozhodnutie_id = odvolanie_voci_rozhodnutiu.rozhodnutie_id
        AND rozhodnutie.transakcia_zrusene_id IS NULL
    JOIN spk.spk_konanie 
        ON spk_konanie.spk_konanie_id = rozhodnutie.spk_konanie_id
        AND spk_konanie.transakcia_zrusene_id IS NULL
    JOIN dms.ksed_spis 
        ON ksed_spis.ksed_spis_id = spk_konanie.ksed_spis_id
        AND ksed_spis.transakcia_zrusene_id IS NULL
    JOIN dms.vstupny_dokument 
        ON vstupny_dokument.vstupny_dokument_id = odvolanie_voci_rozhodnutiu_vstupny_dokument.vstupny_dokument_id
        AND vstupny_dokument.transakcia_zrusene_id IS NULL
    JOIN dms.dokument 
        ON dokument.dokument_id = vstupny_dokument.vstupny_dokument_id
        AND dokument.transakcia_zrusene_id IS NULL
    JOIN cis.cis_typ_vstupneho_artefaktu 
        ON cis_typ_vstupneho_artefaktu.cis_typ_vstupneho_artefaktu_id = vstupny_dokument.cis_typ_vstupneho_artefaktu_id
        AND cis_typ_vstupneho_artefaktu.transakcia_zrusene_id IS NULL
    LEFT JOIN dms.priloha 
        ON priloha.dokument_id = dokument.dokument_id
        AND priloha.transakcia_zrusene_id IS NULL
    WHERE odvolanie_voci_rozhodnutiu.transakcia_zrusene_id IS NULL
      AND (p_odvolanie_voci_rozhodnutiu_id IS NULL OR odvolanie_voci_rozhodnutiu.odvolanie_voci_rozhodnutiu_id = p_odvolanie_voci_rozhodnutiu_id)
    ORDER BY dokument.datum_vytvorenia, cis_typ_vstupneho_artefaktu.nazov;
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_odvolanie_v_rozh_vyjadrenie_ucastnikov_vstupn(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_odvolanie_v_rozh_vyjadrenie_ucastnikov_vstupn(p_odvolanie_voci_rozhodnutiu_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, rozhodnutie_id bigint, cislo_rozhodnutia character varying, dokument_nazov text, typ_vstupneho_dokumentu text, priloha_nazov_suboru text, datum_vytvorenia text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        spk_konanie.spk_konanie_id,
        spk_konanie.cislo_konania,
        rozhodnutie.rozhodnutie_id,
        rozhodnutie.cislo_rozhodnutia,
        dokument.nazov,
        cis_typ_vstupneho_artefaktu.nazov,
        priloha.nazov_suboru,
        TO_CHAR(dokument.datum_vytvorenia, 'DD.MM.YYYY')
    FROM spk.vyjadrenie_ucastnikov vu
    JOIN spk.vyjadrenie_ucastnikov_vstupny_dokument vuvd 
        ON vuvd.vyjadrenie_ucastnikov_id = vu.vyjadrenie_ucastnikov_id
        AND vuvd.vyjadrenie_ucastnikov_vstupny_dokument_id IS NOT NULL
    JOIN spk.odvolanie_voci_rozhodnutiu ovr 
        ON ovr.odvolanie_voci_rozhodnutiu_id = vu.odvolanie_voci_rozhodnutiu_id
        AND ovr.transakcia_zrusene_id IS NULL
    JOIN spk.rozhodnutie 
        ON rozhodnutie.rozhodnutie_id = ovr.rozhodnutie_id
        AND rozhodnutie.transakcia_zrusene_id IS NULL
    JOIN spk.spk_konanie 
        ON spk_konanie.spk_konanie_id = rozhodnutie.spk_konanie_id
        AND spk_konanie.transakcia_zrusene_id IS NULL
    JOIN dms.ksed_spis 
        ON ksed_spis.ksed_spis_id = spk_konanie.ksed_spis_id
        AND ksed_spis.transakcia_zrusene_id IS NULL
    JOIN dms.vstupny_dokument 
        ON vstupny_dokument.vstupny_dokument_id = vuvd.vstupny_dokument_id
        AND vstupny_dokument.transakcia_zrusene_id IS NULL
    JOIN dms.dokument 
        ON dokument.dokument_id = vstupny_dokument.vstupny_dokument_id
        AND dokument.transakcia_zrusene_id IS NULL
    JOIN cis.cis_typ_vstupneho_artefaktu 
        ON cis_typ_vstupneho_artefaktu.cis_typ_vstupneho_artefaktu_id = vstupny_dokument.cis_typ_vstupneho_artefaktu_id
        AND cis_typ_vstupneho_artefaktu.transakcia_zrusene_id IS NULL
    LEFT JOIN dms.priloha 
        ON priloha.dokument_id = dokument.dokument_id
        AND priloha.transakcia_zrusene_id IS NULL
    WHERE 
        vu.vyjadrenie_ucastnikov_id IS NOT NULL
        AND (p_odvolanie_voci_rozhodnutiu_id IS NULL OR ovr.odvolanie_voci_rozhodnutiu_id = p_odvolanie_voci_rozhodnutiu_id)
    ORDER BY dokument.datum_vytvorenia, cis_typ_vstupneho_artefaktu.nazov;
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_odvolanie_v_rozh_vystupny_dokument(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_odvolanie_v_rozh_vystupny_dokument(p_odvolanie_voci_rozhodnutiu_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, rozhodnutie_id bigint, cislo_rozhodnutia character varying, dokument_nazov text, typ_vystupneho_dokumentu text, priloha_nazov_suboru text, datum_vytvorenia text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        spk_konanie.spk_konanie_id,
        spk_konanie.cislo_konania,
        rozhodnutie.rozhodnutie_id,
        rozhodnutie.cislo_rozhodnutia,
        dokument.nazov,
        cis_typ_vystupneho_artefaktu.nazov::text,
        priloha.nazov_suboru,
        TO_CHAR(dokument.datum_vytvorenia, 'DD.MM.YYYY')
    FROM spk.odvolanie_voci_rozhodnutiu
    JOIN spk.odvolanie_voci_rozhodnutiu_vystupny_dokument 
        ON odvolanie_voci_rozhodnutiu_vystupny_dokument.odvolanie_voci_rozhodnutiu_id = odvolanie_voci_rozhodnutiu.odvolanie_voci_rozhodnutiu_id
        AND odvolanie_voci_rozhodnutiu_vystupny_dokument.transakcia_zrusene_id IS NULL
    JOIN spk.rozhodnutie 
        ON rozhodnutie.rozhodnutie_id = odvolanie_voci_rozhodnutiu.rozhodnutie_id
        AND rozhodnutie.transakcia_zrusene_id IS NULL
    JOIN spk.spk_konanie 
        ON spk_konanie.spk_konanie_id = rozhodnutie.spk_konanie_id
        AND spk_konanie.transakcia_zrusene_id IS NULL
    JOIN dms.ksed_spis 
        ON ksed_spis.ksed_spis_id = spk_konanie.ksed_spis_id
        AND ksed_spis.transakcia_zrusene_id IS NULL
    JOIN dms.vystupny_dokument 
        ON vystupny_dokument.vystupny_dokument_id = odvolanie_voci_rozhodnutiu_vystupny_dokument.vystupny_dokument_id
        AND vystupny_dokument.transakcia_zrusene_id IS NULL
    JOIN dms.dokument 
        ON dokument.dokument_id = vystupny_dokument.vystupny_dokument_id
        AND dokument.transakcia_zrusene_id IS NULL
    JOIN cis.cis_typ_vystupneho_artefaktu 
        ON cis_typ_vystupneho_artefaktu.cis_typ_vystupneho_artefaktu_id = vystupny_dokument.cis_typ_vystupneho_artefaktu_id
        AND cis_typ_vystupneho_artefaktu.transakcia_zrusene_id IS NULL
    LEFT JOIN dms.priloha 
        ON priloha.dokument_id = dokument.dokument_id
        AND priloha.transakcia_zrusene_id IS NULL
    WHERE odvolanie_voci_rozhodnutiu.transakcia_zrusene_id IS NULL
      AND (p_odvolanie_voci_rozhodnutiu_id IS NULL OR odvolanie_voci_rozhodnutiu.odvolanie_voci_rozhodnutiu_id = p_odvolanie_voci_rozhodnutiu_id)
    ORDER BY dokument.datum_vytvorenia, cis_typ_vystupneho_artefaktu.nazov;
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_odvolanie_v_rozh_zaloba_rozhodnutie_vystupny_dok(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_odvolanie_v_rozh_zaloba_rozhodnutie_vystupny_dok(p_odvolanie_voci_rozhodnutiu_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, rozhodnutie_id bigint, cislo_rozhodnutia text, odvolanie_voci_rozhodnutiu_id bigint, dokument_nazov text, typ_vystupneho_dokumentu_nazov text, priloha_nazov_suboru text, datum_vytvorenia_dokumentu text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        sk.spk_konanie_id,
        sk.cislo_konania,
        r.rozhodnutie_id,
        r.cislo_rozhodnutia::text,
        ovr.odvolanie_voci_rozhodnutiu_id,
        d.nazov AS dokument_nazov,
        cta.nazov::text AS typ_vystupneho_dokumentu_nazov,
        p.nazov_suboru AS priloha_nazov_suboru,
        TO_CHAR(d.datum_vytvorenia, 'DD.MM.YYYY') AS datum_vytvorenia_dokumentu
    FROM spk.zaloba z
    JOIN spk.rozhodnutie r 
        ON r.rozhodnutie_id = z.rozhodnutie_id AND r.transakcia_zrusene_id IS NULL
    JOIN spk.spk_konanie sk 
        ON sk.spk_konanie_id = r.spk_konanie_id AND sk.transakcia_zrusene_id IS NULL
    JOIN spk.odvolanie_voci_rozhodnutiu ovr 
        ON ovr.rozhodnutie_id = r.rozhodnutie_id AND ovr.transakcia_zrusene_id IS NULL
    JOIN spk.odvolanie_voci_rozhodnutiu_vystupny_dokument ovrd 
        ON ovrd.odvolanie_voci_rozhodnutiu_id = ovr.odvolanie_voci_rozhodnutiu_id AND ovrd.transakcia_zrusene_id IS NULL
    JOIN dms.vystupny_dokument vd 
        ON vd.vystupny_dokument_id = ovrd.vystupny_dokument_id AND vd.transakcia_zrusene_id IS NULL
    JOIN dms.dokument d 
        ON d.dokument_id = vd.vystupny_dokument_id AND d.transakcia_zrusene_id IS NULL
    JOIN cis.cis_typ_vystupneho_artefaktu cta 
        ON cta.cis_typ_vystupneho_artefaktu_id = vd.cis_typ_vystupneho_artefaktu_id AND cta.transakcia_zrusene_id IS NULL
    LEFT JOIN dms.priloha p 
        ON p.dokument_id = d.dokument_id AND p.transakcia_zrusene_id IS NULL
    WHERE z.transakcia_zrusene_id IS NULL
      AND (p_odvolanie_voci_rozhodnutiu_id IS NULL OR ovr.odvolanie_voci_rozhodnutiu_id = p_odvolanie_voci_rozhodnutiu_id)
    ORDER BY d.datum_vytvorenia, cta.nazov;
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_ohliadka(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_ohliadka(p_ohliadka_id bigint)
 RETURNS TABLE(datum_oznamenia_ohliadky text, den_ohliadky_a_cas_zaciatku_ohliadky text, lokalita_opis text, katastralne_uzemie text, sidelna_jednotka text, obec text, ulica text, supisne_cislo text, orientacne_cislo text, psc text, jprl text, cislo_parcely text, adresa text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        TO_CHAR(o.datum_oznamenia_ohliadky, 'DD.MM.YYYY') AS datum_oznamenia_ohliadky,
        TO_CHAR(o.den_ohliadky_a_cas_zaciatku_ohliadky, 'DD.MM.YYYY HH24:MI') AS den_ohliadky_a_cas_zaciatku_ohliadky,
        l.lokalita_opis,
        l.katastralne_uzemie,
        l.sidelna_jednotka,
        l.obec::text,
        l.ulica,
        l.supisne_cislo,
        l.orientacne_cislo,
        l.psc,
        l.jprl,
        l.cislo_parcely,
        l.adresa
    FROM 
        spk.ohliadka o
    LEFT JOIN 
        artefakt.uni_lokalita l ON l.lokalita_id = o.lokalita_id
    INNER JOIN 
        spk.zabezpecenie_konania zk ON zk.zabezpecenie_konania_id = o.zabezpecenie_konania_id AND zk.transakcia_zrusene_id IS NULL
    INNER JOIN 
        spk.spk_konanie k ON k.spk_konanie_id = zk.spk_konanie_id AND k.transakcia_zrusene_id IS NULL
    WHERE 
        (p_ohliadka_id IS NULL OR o.ohliadka_id = p_ohliadka_id)
		 AND o.transakcia_zrusene_id IS NULL;
END $function$
;

-- DROP FUNCTION artefakt.lok_spk_ohliadka_na_vedomie_zucastneny_subjekt(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_ohliadka_na_vedomie_zucastneny_subjekt(p_ohliadka_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, zucastneny_subjekt_nazov text, zucastneny_subjekt_rola text, zucastneny_subjekt_druh_subjektu text, adresa_typ_adresy text, adresa_obec text, adresa_ulica text, adresa_supisne_cislo text, adresa_orientacne_cislo text, adresa_psc text, adresa_stat text, adresa_subjektu text, ico text, ico_txt text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT DISTINCT
        k.spk_konanie_id,
        u.zucastneny_subjekt_nazov::text,
        u.zucastneny_subjekt_rola,
        u.zucastneny_subjekt_druh_subjektu::text,
        u.adresa_typ_adresy::text,
        u.adresa_obec::text,
        u.adresa_ulica::text,
        u.adresa_supisne_cislo::text,
        u.adresa_orientacne_cislo::text,
        u.adresa_psc::text,
        u.adresa_stat::text,
        u.adresa_subjektu::text,
        u.ico::text,
        'IČO: ' || COALESCE(u.ico::text, '') as ico_txt
    FROM spk.ohliadka o
    INNER JOIN spk.zabezpecenie_konania zk
        ON o.zabezpecenie_konania_id = zk.zabezpecenie_konania_id
        AND zk.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON zk.spk_konanie_id = k.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN ksed.na_vedomie_zucastneny_subjekt nv
        ON nv.zabezpecenie_konania_id = o.zabezpecenie_konania_id
        AND nv.transakcia_zrusene_id IS NULL
    INNER JOIN artefakt.uni_zucastneny_subjekt u
        ON u.zucastneny_subjekt_id = nv.zucastneny_subjekt_id
    WHERE o.transakcia_zrusene_id IS NULL
      AND (p_ohliadka_id IS NULL OR o.ohliadka_id = p_ohliadka_id)
    ORDER BY k.spk_konanie_id;
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_ohliadka_ustne_pojednavanie(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_ohliadka_ustne_pojednavanie(p_ohliadka_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, datum_uskutocnenia text, miestnost text, poschodie bigint, sidlo_spravneho_organu_adresa text, verejne_zhromazdenie text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        k.spk_konanie_id,
        k.cislo_konania,
        TO_CHAR(up.datum_uskutocnenia, 'DD.MM.YYYY') AS datum_uskutocnenia,
        up.miestnost,
        up.poschodie,
        up.sidlo_spravneho_organu_adresa,
        CASE WHEN up.verejne_zhromazdenie THEN 'áno' ELSE 'nie' END AS verejne_zhromazdenie
		--lokalita_id
    FROM spk.ustne_pojednavanie up
    INNER JOIN spk.ustne_pojednavanie_ohliadka upo 
        ON upo.ustne_pojednavanie_id = up.ustne_pojednavanie_id
    INNER JOIN spk.ohliadka o
        ON o.ohliadka_id = upo.ohliadka_id AND o.transakcia_zrusene_id IS NULL
    INNER JOIN spk.zabezpecenie_konania zk
        ON up.zabezpecenie_konania_id = zk.zabezpecenie_konania_id 
        AND zk.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON k.spk_konanie_id = zk.spk_konanie_id 
        AND k.transakcia_zrusene_id IS NULL
    WHERE 
        (p_ohliadka_id IS NULL OR o.ohliadka_id = p_ohliadka_id)
        AND up.transakcia_zrusene_id IS NULL
;
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_ohliadka_zabezpecenie_konania(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_ohliadka_zabezpecenie_konania(p_ohliadka_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, ohliadka_id bigint, procesny_ukon_nazov text, procesny_ukon_popis text, znenie text, datum_zrusenia text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
--ohliadka_id = 100011
    SELECT
        k.spk_konanie_id,
        k.cislo_konania,
		o.ohliadka_id,
        zk.procesny_ukon_nazov,
        zk.procesny_ukon_popis,
        zk.znenie,
        TO_CHAR(zk.datum_zrusenia, 'DD.MM.YYYY') AS datum_zrusenia
    FROM spk.zabezpecenie_konania zk
    INNER JOIN spk.spk_konanie k
        ON k.spk_konanie_id = zk.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN spk.ohliadka o
        ON o.zabezpecenie_konania_id = zk.zabezpecenie_konania_id
        AND o.transakcia_zrusene_id IS NULL
    WHERE zk.transakcia_zrusene_id IS NULL
      AND (p_ohliadka_id IS NULL OR o.ohliadka_id = p_ohliadka_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_ohliadka_zabezpecenie_konania_zucastneny_subjekt(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_ohliadka_zabezpecenie_konania_zucastneny_subjekt(p_ohliadka_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, zucastneny_subjekt_nazov text, zucastneny_subjekt_rola text, zucastneny_subjekt_druh_subjektu text, adresa_typ_adresy text, adresa_obec text, adresa_ulica text, adresa_supisne_cislo text, adresa_orientacne_cislo text, adresa_psc text, adresa_stat text, adresa_subjektu text, ico text, ico_txt text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT DISTINCT
        k.spk_konanie_id,
        u.zucastneny_subjekt_nazov::text,
        u.zucastneny_subjekt_rola,
        u.zucastneny_subjekt_druh_subjektu::text,
        u.adresa_typ_adresy::text,
        u.adresa_obec::text,
        u.adresa_ulica::text,
        u.adresa_supisne_cislo::text,
        u.adresa_orientacne_cislo::text,
        u.adresa_psc::text,
        u.adresa_stat::text,
        u.adresa_subjektu::text,
        u.ico::text,
        'IČO: ' || COALESCE(u.ico::text, '') as ico_txt
    FROM spk.ohliadka o
    INNER JOIN spk.zabezpecenie_konania zk
        ON o.zabezpecenie_konania_id = zk.zabezpecenie_konania_id
        AND zk.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON zk.spk_konanie_id = k.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN artefakt.uni_zucastneny_subjekt u
        ON u.zucastneny_subjekt_id = zk.zucastneny_subjekt_id
    WHERE o.transakcia_zrusene_id IS NULL
      AND (p_ohliadka_id IS NULL OR o.ohliadka_id = p_ohliadka_id)
    ORDER BY k.spk_konanie_id;
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_predbezne_opatrenie(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_predbezne_opatrenie(p_predbezne_opatrenie_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, datum_zaevidovania text, splnene text, kod_dovod_zrusenia text, nazov_dovod_zrusenia text, kod_sankcia_opatrenie text, nazov_sankcia_opatrenie text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT
        k.spk_konanie_id,
        k.cislo_konania,
        TO_CHAR(po.datum_zaevidovania, 'DD.MM.YYYY') AS datum_zaevidovania,
        CASE WHEN po.splnene THEN 'áno' ELSE 'nie' END AS splnene,
        cz.kod AS kod_dovod_zrusenia,
        cz.nazov AS nazov_dovod_zrusenia,
        cs.kod AS kod_sankcia_opatrenie,
        cs.nazov AS nazov_sankcia_opatrenie
    FROM spk.predbezne_opatrenie po
    INNER JOIN spk.zabezpecenie_konania zk
        ON po.zabezpecenie_konania_id = zk.zabezpecenie_konania_id
        AND zk.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON zk.spk_konanie_id = k.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    LEFT JOIN cis.cis_dovod_zrusenia_predbezneho_opatrenia cz
        ON po.cis_dovod_zrusenia_predbezneho_opatrenia_id = cz.cis_dovod_zrusenia_predbezneho_opatrenia_id
    LEFT JOIN cis.cis_sankcia_opatrenie cs
        ON po.cis_sankcia_opatrenie_id = cs.cis_sankcia_opatrenie_id
    WHERE po.transakcia_zrusene_id IS NULL
        AND (p_predbezne_opatrenie_id IS NULL OR po.predbezne_opatrenie_id = p_predbezne_opatrenie_id);
END $function$
;

-- DROP FUNCTION artefakt.lok_spk_predbezne_opatrenie_na_vedomie_zucastneny_subjekt(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_predbezne_opatrenie_na_vedomie_zucastneny_subjekt(p_predbezne_opatrenie_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, zucastneny_subjekt_nazov text, zucastneny_subjekt_rola text, zucastneny_subjekt_druh_subjektu text, adresa_typ_adresy text, adresa_obec text, adresa_ulica text, adresa_supisne_cislo text, adresa_orientacne_cislo text, adresa_psc text, adresa_stat text, adresa_subjektu text, ico text, ico_txt text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT DISTINCT
        k.spk_konanie_id,
        u.zucastneny_subjekt_nazov::text,
        u.zucastneny_subjekt_rola,
        u.zucastneny_subjekt_druh_subjektu::text,
        u.adresa_typ_adresy::text,
        u.adresa_obec::text,
        u.adresa_ulica::text,
        u.adresa_supisne_cislo::text,
        u.adresa_orientacne_cislo::text,
        u.adresa_psc::text,
        u.adresa_stat::text,
        u.adresa_subjektu::text,
        u.ico::text,
        'IČO: ' || COALESCE(u.ico::text, '') as ico_txt
    FROM spk.predbezne_opatrenie po
    INNER JOIN spk.zabezpecenie_konania zk
        ON po.zabezpecenie_konania_id = zk.zabezpecenie_konania_id
        AND zk.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON zk.spk_konanie_id = k.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN ksed.na_vedomie_zucastneny_subjekt nv
        ON nv.zabezpecenie_konania_id = po.zabezpecenie_konania_id
        AND nv.transakcia_zrusene_id IS NULL
    INNER JOIN artefakt.uni_zucastneny_subjekt u
        ON u.zucastneny_subjekt_id = nv.zucastneny_subjekt_id
    WHERE po.transakcia_zrusene_id IS NULL
      AND (p_predbezne_opatrenie_id IS NULL OR po.predbezne_opatrenie_id = p_predbezne_opatrenie_id)
    ORDER BY k.spk_konanie_id;
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_predbezne_opatrenie_zabezpecenie_konania(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_predbezne_opatrenie_zabezpecenie_konania(p_predbezne_opatrenie_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, predbezne_opatrenie_id bigint, procesny_ukon_nazov text, procesny_ukon_popis text, znenie text, datum_zrusenia text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT
        k.spk_konanie_id,
        k.cislo_konania,
        p.predbezne_opatrenie_id,
        zk.procesny_ukon_nazov,
        zk.procesny_ukon_popis,
        zk.znenie,
        TO_CHAR(zk.datum_zrusenia, 'DD.MM.YYYY')
    FROM spk.zabezpecenie_konania zk
    INNER JOIN spk.spk_konanie k ON k.spk_konanie_id = zk.spk_konanie_id AND k.transakcia_zrusene_id IS NULL
    INNER JOIN spk.predbezne_opatrenie p ON p.zabezpecenie_konania_id = zk.zabezpecenie_konania_id AND p.transakcia_zrusene_id IS NULL
    WHERE zk.transakcia_zrusene_id IS NULL
      AND (p_predbezne_opatrenie_id IS NULL OR p.predbezne_opatrenie_id = p_predbezne_opatrenie_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_predbezne_opatrenie_zucastneny_subjekt(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_predbezne_opatrenie_zucastneny_subjekt(p_predbezne_opatrenie_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, zucastneny_subjekt_nazov text, zucastneny_subjekt_rola text, zucastneny_subjekt_druh_subjektu text, adresa_typ_adresy text, adresa_obec text, adresa_ulica text, adresa_supisne_cislo text, adresa_orientacne_cislo text, adresa_psc text, adresa_stat text, adresa_subjektu text, ico text, ico_txt text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT DISTINCT
        k.spk_konanie_id,
        u.zucastneny_subjekt_nazov::text,
        u.zucastneny_subjekt_rola,
        u.zucastneny_subjekt_druh_subjektu::text,
        u.adresa_typ_adresy::text,
        u.adresa_obec::text,
        u.adresa_ulica::text,
        u.adresa_supisne_cislo::text,
        u.adresa_orientacne_cislo::text,
        u.adresa_psc::text,
        u.adresa_stat::text,
        u.adresa_subjektu::text,
        u.ico::text,
        'IČO: ' || COALESCE(u.ico::text, '') as ico_txt
    FROM spk.predbezne_opatrenie po
    INNER JOIN spk.zabezpecenie_konania zk
        ON po.zabezpecenie_konania_id = zk.zabezpecenie_konania_id
        AND zk.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON zk.spk_konanie_id = k.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN artefakt.uni_zucastneny_subjekt u
        ON u.zucastneny_subjekt_id = zk.zucastneny_subjekt_id
    WHERE po.transakcia_zrusene_id IS NULL
      AND (p_predbezne_opatrenie_id IS NULL OR po.predbezne_opatrenie_id = p_predbezne_opatrenie_id)
    ORDER BY k.spk_konanie_id;
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_predvedenie(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_predvedenie(p_predvedenie_id bigint)
 RETURNS TABLE(predvedenie_id bigint, datum_a_cas_predvedenia text, policajny_zbor text, lokalita_opis text, katastralne_uzemie text, sidelna_jednotka text, obec text, ulica text, supisne_cislo text, orientacne_cislo text, psc text, jprl text, cislo_parcely text, adresa text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        p.predvedenie_id,
        TO_CHAR(p.datum_a_cas_predvedenia, 'DD.MM.YYYY HH24:MI') AS datum_a_cas_predvedenia,
        INITCAP(p.policajny_zbor) AS policajny_zbor,
        l.lokalita_opis,
        l.katastralne_uzemie,
        l.sidelna_jednotka,
        l.obec::text,
        l.ulica,
        l.supisne_cislo,
        l.orientacne_cislo,
        l.psc,
        l.jprl,
        l.cislo_parcely,
        l.adresa
    FROM 
        spk.predvedenie p
    LEFT JOIN 
        artefakt.uni_lokalita l ON l.lokalita_id = p.lokalita_id
    INNER JOIN 
        spk.zabezpecenie_konania zk ON zk.zabezpecenie_konania_id = p.zabezpecenie_konania_id AND zk.transakcia_zrusene_id IS NULL
    INNER JOIN 
        spk.spk_konanie k ON k.spk_konanie_id = zk.spk_konanie_id AND k.transakcia_zrusene_id IS NULL
    WHERE 
        (p_predvedenie_id IS NULL OR p.predvedenie_id = p_predvedenie_id)
	AND p.transakcia_zrusene_id IS NULL;
END $function$
;

-- DROP FUNCTION artefakt.lok_spk_predvedenie_na_vedomie_zucastneny_subjekt(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_predvedenie_na_vedomie_zucastneny_subjekt(p_predvedenie_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, zucastneny_subjekt_nazov text, zucastneny_subjekt_rola text, zucastneny_subjekt_druh_subjektu text, adresa_typ_adresy text, adresa_obec text, adresa_ulica text, adresa_supisne_cislo text, adresa_orientacne_cislo text, adresa_psc text, adresa_stat text, adresa_subjektu text, ico text, ico_txt text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT DISTINCT
        k.spk_konanie_id,
        u.zucastneny_subjekt_nazov::text,
        u.zucastneny_subjekt_rola,
        u.zucastneny_subjekt_druh_subjektu::text,
        u.adresa_typ_adresy::text,
        u.adresa_obec::text,
        u.adresa_ulica::text,
        u.adresa_supisne_cislo::text,
        u.adresa_orientacne_cislo::text,
        u.adresa_psc::text,
        u.adresa_stat::text,
        u.adresa_subjektu::text,
        u.ico::text,
        'IČO: ' || COALESCE(u.ico::text, '') as ico_txt
    FROM spk.predvedenie p
    INNER JOIN spk.zabezpecenie_konania zk
        ON p.zabezpecenie_konania_id = zk.zabezpecenie_konania_id
        AND zk.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON zk.spk_konanie_id = k.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN ksed.na_vedomie_zucastneny_subjekt nv
        ON nv.zabezpecenie_konania_id = p.zabezpecenie_konania_id
        AND nv.transakcia_zrusene_id IS NULL
    INNER JOIN artefakt.uni_zucastneny_subjekt u
        ON u.zucastneny_subjekt_id = nv.zucastneny_subjekt_id
    WHERE p.transakcia_zrusene_id IS NULL
      AND (p_predvedenie_id IS NULL OR p.predvedenie_id = p_predvedenie_id)
    ORDER BY k.spk_konanie_id;
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_predvedenie_zabezpecenie_konania(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_predvedenie_zabezpecenie_konania(p_predvedenie_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, predvedenie_id bigint, procesny_ukon_nazov text, procesny_ukon_popis text, znenie text, datum_zrusenia text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT
        k.spk_konanie_id,
        k.cislo_konania,
        p.predvedenie_id,
        zk.procesny_ukon_nazov,
        zk.procesny_ukon_popis,
        zk.znenie,
        TO_CHAR(zk.datum_zrusenia, 'DD.MM.YYYY')
    FROM spk.zabezpecenie_konania zk
    INNER JOIN spk.spk_konanie k ON k.spk_konanie_id = zk.spk_konanie_id AND k.transakcia_zrusene_id IS NULL
    INNER JOIN spk.predvedenie p ON p.zabezpecenie_konania_id = zk.zabezpecenie_konania_id AND p.transakcia_zrusene_id IS NULL
    WHERE zk.transakcia_zrusene_id IS NULL
      AND (p_predvedenie_id IS NULL OR p.predvedenie_id = p_predvedenie_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_predvedenie_zucastneny_subjekt(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_predvedenie_zucastneny_subjekt(p_predvedenie_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, zucastneny_subjekt_nazov text, zucastneny_subjekt_rola text, zucastneny_subjekt_druh_subjektu text, adresa_typ_adresy text, adresa_obec text, adresa_ulica text, adresa_supisne_cislo text, adresa_orientacne_cislo text, adresa_psc text, adresa_stat text, adresa_subjektu text, ico text, ico_txt text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT DISTINCT
        k.spk_konanie_id,
        u.zucastneny_subjekt_nazov::text,
        u.zucastneny_subjekt_rola,
        u.zucastneny_subjekt_druh_subjektu::text,
        u.adresa_typ_adresy::text,
        u.adresa_obec::text,
        u.adresa_ulica::text,
        u.adresa_supisne_cislo::text,
        u.adresa_orientacne_cislo::text,
        u.adresa_psc::text,
        u.adresa_stat::text,
        u.adresa_subjektu::text,
        u.ico::text,
        'IČO: ' || COALESCE(u.ico::text, '') as ico_txt
    FROM spk.predvedenie p
    INNER JOIN spk.zabezpecenie_konania zk
        ON p.zabezpecenie_konania_id = zk.zabezpecenie_konania_id
        AND zk.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON zk.spk_konanie_id = k.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN artefakt.uni_zucastneny_subjekt u
        ON u.zucastneny_subjekt_id = zk.zucastneny_subjekt_id
    WHERE p.transakcia_zrusene_id IS NULL
      AND (p_predvedenie_id IS NULL OR p.predvedenie_id = p_predvedenie_id)
    ORDER BY k.spk_konanie_id;
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_predvolanie(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_predvolanie(p_predvolanie_id bigint)
 RETURNS TABLE(datum_a_cas_predvolania text, datum_a_cas_uskutocnenia_predvolania text, datum_vystavenia text, lokalita_opis text, katastralne_uzemie text, sidelna_jednotka text, obec text, ulica text, supisne_cislo text, orientacne_cislo text, psc text, jprl text, cislo_parcely text, adresa text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        TO_CHAR(p.datum_a_cas_predvolania, 'DD.MM.YYYY HH24:MI') AS datum_a_cas_predvolania,
        TO_CHAR(p.datum_a_cas_uskutocnenia_predvolania, 'DD.MM.YYYY HH24:MI') AS datum_a_cas_uskutocnenia_predvolania,
        TO_CHAR(p.datum_vystavenia, 'DD.MM.YYYY') AS datum_vystavenia,
        l.lokalita_opis,
        l.katastralne_uzemie,
        l.sidelna_jednotka,
        l.obec::text,
        l.ulica,
        l.supisne_cislo,
        l.orientacne_cislo,
        l.psc,
        l.jprl,
        l.cislo_parcely,
        l.adresa
    FROM 
        spk.predvolanie p
    INNER JOIN 
        spk.zabezpecenie_konania zk ON zk.zabezpecenie_konania_id = p.zabezpecenie_konania_id AND zk.transakcia_zrusene_id IS NULL
    INNER JOIN 
        spk.spk_konanie k ON k.spk_konanie_id = zk.spk_konanie_id AND k.transakcia_zrusene_id IS NULL
    LEFT JOIN 
        artefakt.uni_lokalita l ON l.lokalita_id = p.lokalita_id
    WHERE 
        (p_predvolanie_id IS NULL OR p.predvolanie_id = p_predvolanie_id)
	AND p.transakcia_zrusene_id IS NULL;
END $function$
;

-- DROP FUNCTION artefakt.lok_spk_predvolanie_na_vedomie_zucastneny_subjekt(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_predvolanie_na_vedomie_zucastneny_subjekt(p_predvolanie_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, zucastneny_subjekt_nazov text, zucastneny_subjekt_rola text, zucastneny_subjekt_druh_subjektu text, adresa_typ_adresy text, adresa_obec text, adresa_ulica text, adresa_supisne_cislo text, adresa_orientacne_cislo text, adresa_psc text, adresa_stat text, adresa_subjektu text, ico text, ico_txt text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT DISTINCT
        k.spk_konanie_id,
        u.zucastneny_subjekt_nazov::text,
        u.zucastneny_subjekt_rola,
        u.zucastneny_subjekt_druh_subjektu::text,
        u.adresa_typ_adresy::text,
        u.adresa_obec::text,
        u.adresa_ulica::text,
        u.adresa_supisne_cislo::text,
        u.adresa_orientacne_cislo::text,
        u.adresa_psc::text,
        u.adresa_stat::text,
        u.adresa_subjektu::text,
        u.ico::text,
        'IČO: ' || COALESCE(u.ico::text, '') as ico_txt
    FROM spk.predvolanie p
    INNER JOIN spk.zabezpecenie_konania zk
        ON p.zabezpecenie_konania_id = zk.zabezpecenie_konania_id
        AND zk.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON zk.spk_konanie_id = k.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN ksed.na_vedomie_zucastneny_subjekt nv
        ON nv.zabezpecenie_konania_id = p.zabezpecenie_konania_id
        AND nv.transakcia_zrusene_id IS NULL
    INNER JOIN artefakt.uni_zucastneny_subjekt u
        ON u.zucastneny_subjekt_id = nv.zucastneny_subjekt_id
    WHERE p.transakcia_zrusene_id IS NULL
      AND (p_predvolanie_id IS NULL OR p.predvolanie_id = p_predvolanie_id)
    ORDER BY k.spk_konanie_id;
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_predvolanie_zabezpecenie_konania(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_predvolanie_zabezpecenie_konania(p_predvolanie_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, predvolanie_id bigint, procesny_ukon_nazov text, procesny_ukon_popis text, znenie text, datum_zrusenia text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT
        k.spk_konanie_id,
        k.cislo_konania,
        p.predvolanie_id,
        zk.procesny_ukon_nazov,
        zk.procesny_ukon_popis,
        zk.znenie,
        TO_CHAR(zk.datum_zrusenia, 'DD.MM.YYYY')
    FROM spk.zabezpecenie_konania zk
    INNER JOIN spk.spk_konanie k ON k.spk_konanie_id = zk.spk_konanie_id AND k.transakcia_zrusene_id IS NULL
    INNER JOIN spk.predvolanie p ON p.zabezpecenie_konania_id = zk.zabezpecenie_konania_id AND p.transakcia_zrusene_id IS NULL
    WHERE zk.transakcia_zrusene_id IS NULL
      AND (p_predvolanie_id IS NULL OR p.predvolanie_id = p_predvolanie_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_predvolanie_zucastneny_subjekt(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_predvolanie_zucastneny_subjekt(p_predvolanie_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, zucastneny_subjekt_nazov text, zucastneny_subjekt_rola text, zucastneny_subjekt_druh_subjektu text, adresa_typ_adresy text, adresa_obec text, adresa_ulica text, adresa_supisne_cislo text, adresa_orientacne_cislo text, adresa_psc text, adresa_stat text, adresa_subjektu text, ico text, ico_txt text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT DISTINCT
        k.spk_konanie_id,
        u.zucastneny_subjekt_nazov::text,
        u.zucastneny_subjekt_rola,
        u.zucastneny_subjekt_druh_subjektu::text,
        u.adresa_typ_adresy::text,
        u.adresa_obec::text,
        u.adresa_ulica::text,
        u.adresa_supisne_cislo::text,
        u.adresa_orientacne_cislo::text,
        u.adresa_psc::text,
        u.adresa_stat::text,
        u.adresa_subjektu::text,
        u.ico::text,
        'IČO: ' || COALESCE(u.ico::text, '') as ico_txt
    FROM spk.predvolanie p
    INNER JOIN spk.zabezpecenie_konania zk
        ON p.zabezpecenie_konania_id = zk.zabezpecenie_konania_id
        AND zk.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON zk.spk_konanie_id = k.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN artefakt.uni_zucastneny_subjekt u
        ON u.zucastneny_subjekt_id = zk.zucastneny_subjekt_id
    WHERE p.transakcia_zrusene_id IS NULL
      AND (p_predvolanie_id IS NULL OR p.predvolanie_id = p_predvolanie_id)
    ORDER BY k.spk_konanie_id;
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_prerusenie_konania(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_prerusenie_konania(p_prerusenie_konania_id bigint)
 RETURNS TABLE(datum_ukoncenia_preruseni text, doba_prerusenia bigint, iny_dovod_prerusenia text, prerusenie_do text, prerusenie_od text, dovod_prerusenia_kod text, dovod_prerusenia_nazov text, dovod_ukoncenia_kod text, dovod_ukoncenia_nazov text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        TO_CHAR(pk.datum_ukoncenia_preruseni, 'DD.MM.YYYY') AS datum_ukoncenia_preruseni,
        pk.doba_prerusenia,
        pk.iny_dovod_prerusenia,
        TO_CHAR(pk.prerusenie_do, 'DD.MM.YYYY') AS prerusenie_do,
        TO_CHAR(pk.prerusenie_od, 'DD.MM.YYYY') AS prerusenie_od,
        cdp.kod AS dovod_prerusenia_kod,
        cdp.nazov AS dovod_prerusenia_nazov,
        cdu.kod AS dovod_ukoncenia_kod,
        cdu.nazov AS dovod_ukoncenia_nazov
    FROM spk.prerusenie_konania pk
    LEFT JOIN cis.cis_dovod_prerusenia_konania cdp 
        ON cdp.cis_dovod_prerusenia_konania_id = pk.cis_dovod_prerusenia_id
    LEFT JOIN cis.cis_dovod_ukoncenia_prerusenia cdu 
        ON cdu.cis_dovod_ukoncenia_prerusenia_id = pk.cis_dovod_ukoncenia_id
    INNER JOIN spk.spk_konanie k 
        ON k.spk_konanie_id = pk.spk_konanie_id 
        AND k.transakcia_zrusene_id IS NULL
    WHERE 
        pk.transakcia_zrusene_id IS NULL
        AND (p_prerusenie_konania_id IS NULL OR pk.prerusenie_konania_id = p_prerusenie_konania_id);
END $function$
;

-- DROP FUNCTION artefakt.lok_spk_rozhodnutie(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_rozhodnutie(p_rozhodnutie_id bigint)
 RETURNS TABLE(cislo_rozhodnutia character varying, datum_dorucenia_rozhodnutia text, datum_pravoplatnosti text, datum_vykonatelnosti text, datum_vystavenia text, datum_zrusenia_rozhodnutia text, dorucenie_verejnou_vyhlaskou text, navrh_rozhodnutia text, popis_rozhodnutia text, poucenie text, rozhodnutie_v_ramci_obnovy_konania text, vyrok text, odovodnenie text, povolene_odvolanie text, rozhodnutie_v_odvolani text, typ_rozhodnutia_kod text, typ_rozhodnutia_nazov text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        r.cislo_rozhodnutia,
        TO_CHAR(r.datum_dorucenia_rozhodnutia, 'DD.MM.YYYY') datum_dorucenia_rozhodnutia,
        TO_CHAR(r.datum_pravoplatnosti, 'DD.MM.YYYY') datum_pravoplatnosti,
        TO_CHAR(r.datum_vykonatelnosti, 'DD.MM.YYYY') datum_vykonatelnosti,
        TO_CHAR(r.datum_vystavenia, 'DD.MM.YYYY') datum_vystavenia,
        TO_CHAR(r.datum_zrusenia_rozhodnutia, 'DD.MM.YYYY') datum_zrusenia_rozhodnutia,
        CASE WHEN r.dorucenie_verejnou_vyhlaskou THEN 'áno' ELSE 'nie' END dorucenie_verejnou_vyhlaskou,
        CASE WHEN r.navrh_rozhodnutia THEN 'áno' ELSE 'nie' END navrh_rozhodnutia,
        r.popis_rozhodnutia,
        r.poucenie,
        CASE WHEN r.rozhodnutie_v_ramci_obnovy_konania THEN 'áno' ELSE 'nie' END rozhodnutie_v_ramci_obnovy_konania,
        r.vyrok,
        r.odovodnenie,
        CASE WHEN r.povolene_odvolanie THEN 'áno' ELSE 'nie' END povolene_odvolanie,
        CASE WHEN r.rozhodnutie_v_odvolani THEN 'áno' ELSE 'nie' END rozhodnutie_v_odvolani,
        ctr.kod typ_rozhodnutia_kod,
        ctr.nazov typ_rozhodnutia_nazov
    FROM spk.rozhodnutie r
    INNER JOIN spk.spk_konanie k ON k.spk_konanie_id = r.spk_konanie_id AND k.transakcia_zrusene_id IS NULL
    LEFT JOIN cis.cis_typ_rozhodnutia ctr ON r.cis_typ_rozhodnutia_id = ctr.cis_typ_rozhodnutia_id AND ctr.transakcia_zrusene_id IS NULL
    WHERE r.transakcia_zrusene_id IS NULL
      AND (p_rozhodnutie_id IS NULL OR r.rozhodnutie_id = p_rozhodnutie_id);
END $function$
;

-- DROP FUNCTION artefakt.lok_spk_rozhodnutie_odvolanie_voci_rozhodnutiu(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_rozhodnutie_odvolanie_voci_rozhodnutiu(p_rozhodnutie_id bigint)
 RETURNS TABLE(odvolanie_voci_rozhodnutiu_id bigint, datum_pod_navrhu_na_mimo_odv_kon text, datum_pod_navrhu_na_obnovu_kon text, datum_prijatia_odvolania text, datum_rozhodnutia_o_odvolani text, datum_upovedomenia_o_odvolani text, vylucenie_odkladneho_ucinku text, cislo_rozhodnutia character varying, sposob_rozhodnutia_kod text, sposob_rozhodnutia_nazov text, typ_odvolania_kod text, typ_odvolania_nazov text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        ov.odvolanie_voci_rozhodnutiu_id,
        TO_CHAR(ov.datum_podania_navrhu_na_mimo_odvolacie_konanie, 'DD.MM.YYYY'),
        TO_CHAR(ov.datum_podania_navrhu_na_obnovu_konania, 'DD.MM.YYYY'),
        TO_CHAR(ov.datum_prijatia_odvolania, 'DD.MM.YYYY'),
        TO_CHAR(ov.datum_rozhodnutia_o_odvolani, 'DD.MM.YYYY'),
        TO_CHAR(ov.datum_upovedomenia_o_odvolani, 'DD.MM.YYYY'),
        CASE WHEN ov.vylucenie_odkladneho_ucinku THEN 'áno' ELSE 'nie' END,
        r.cislo_rozhodnutia,
        csr.kod,
        csr.nazov,
        cto.kod,
        cto.nazov
    FROM 
        spk.odvolanie_voci_rozhodnutiu ov
    INNER JOIN 
        spk.rozhodnutie r 
        ON ov.rozhodnutie_id = r.rozhodnutie_id AND r.transakcia_zrusene_id IS NULL
    INNER JOIN 
        spk.spk_konanie k 
        ON r.spk_konanie_id = k.spk_konanie_id AND k.transakcia_zrusene_id IS NULL
    LEFT JOIN 
        cis.cis_sposob_rozhodnutia_v_odvolacom_konani csr 
        ON ov.cis_sposob_rozhodnutia_v_odvolacom_konani_id = csr.cis_sposob_rozhodnutia_v_odvolacom_konani_id 
        AND csr.transakcia_zrusene_id IS NULL
    LEFT JOIN 
        cis.cis_typ_odvolania cto 
        ON ov.cis_typ_odvolania_id = cto.cis_typ_odvolania_id 
        AND cto.transakcia_zrusene_id IS NULL
    WHERE 
        ov.transakcia_zrusene_id IS NULL
        AND (p_rozhodnutie_id IS NULL OR ov.rozhodnutie_id = p_rozhodnutie_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_rozhodnutie_odvolanie_voci_rozhodnutiu_vstupny_dokument(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_rozhodnutie_odvolanie_voci_rozhodnutiu_vstupny_dokument(p_rozhodnutie_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, rozhodnutie_id bigint, cislo_rozhodnutia character varying, dokument_nazov text, typ_vstupneho_dokumentu text, priloha_nazov_suboru text, datum_vytvorenia text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        sk.spk_konanie_id,
        sk.cislo_konania,
        r.rozhodnutie_id,
        r.cislo_rozhodnutia,
        d.nazov,
        cta.nazov,
        p.nazov_suboru,
        TO_CHAR(d.datum_vytvorenia, 'DD.MM.YYYY')
    FROM spk.odvolanie_voci_rozhodnutiu ovr
    JOIN spk.odvolanie_voci_rozhodnutiu_vstupny_dokument ovrd 
        ON ovrd.odvolanie_voci_rozhodnutiu_id = ovr.odvolanie_voci_rozhodnutiu_id
        AND ovrd.transakcia_zrusene_id IS NULL
    JOIN spk.rozhodnutie r 
        ON r.rozhodnutie_id = ovr.rozhodnutie_id
        AND r.transakcia_zrusene_id IS NULL
    JOIN spk.spk_konanie sk 
        ON sk.spk_konanie_id = r.spk_konanie_id
        AND sk.transakcia_zrusene_id IS NULL
    JOIN dms.ksed_spis ks 
        ON ks.ksed_spis_id = sk.ksed_spis_id
        AND ks.transakcia_zrusene_id IS NULL
    JOIN dms.vstupny_dokument vd 
        ON vd.vstupny_dokument_id = ovrd.vstupny_dokument_id
        AND vd.transakcia_zrusene_id IS NULL
    JOIN dms.dokument d 
        ON d.dokument_id = vd.vstupny_dokument_id
        AND d.transakcia_zrusene_id IS NULL
    JOIN cis.cis_typ_vstupneho_artefaktu cta 
        ON cta.cis_typ_vstupneho_artefaktu_id = vd.cis_typ_vstupneho_artefaktu_id
        AND cta.transakcia_zrusene_id IS NULL
    LEFT JOIN dms.priloha p 
        ON p.dokument_id = d.dokument_id
        AND p.transakcia_zrusene_id IS NULL
    WHERE ovr.transakcia_zrusene_id IS NULL
      AND (p_rozhodnutie_id IS NULL OR ovr.rozhodnutie_id = p_rozhodnutie_id)
    ORDER BY d.datum_vytvorenia, cta.nazov;
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_rozhodnutie_odvolanie_voci_rozhodnutiu_vystupny_dokumen(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_rozhodnutie_odvolanie_voci_rozhodnutiu_vystupny_dokumen(p_rozhodnutie_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, rozhodnutie_id bigint, cislo_rozhodnutia character varying, dokument_nazov text, typ_vystupneho_dokumentu text, priloha_nazov_suboru text, datum_vytvorenia text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        sk.spk_konanie_id,
        sk.cislo_konania,
        r.rozhodnutie_id,
        r.cislo_rozhodnutia,
        d.nazov,
        cta.nazov::text,
        p.nazov_suboru,
        TO_CHAR(d.datum_vytvorenia, 'DD.MM.YYYY')
    FROM spk.odvolanie_voci_rozhodnutiu ovr
    JOIN spk.odvolanie_voci_rozhodnutiu_vystupny_dokument ovrd 
        ON ovrd.odvolanie_voci_rozhodnutiu_id = ovr.odvolanie_voci_rozhodnutiu_id
        AND ovrd.transakcia_zrusene_id IS NULL
    JOIN spk.rozhodnutie r 
        ON r.rozhodnutie_id = ovr.rozhodnutie_id
        AND r.transakcia_zrusene_id IS NULL
    JOIN spk.spk_konanie sk 
        ON sk.spk_konanie_id = r.spk_konanie_id
        AND sk.transakcia_zrusene_id IS NULL
    JOIN dms.ksed_spis ks 
        ON ks.ksed_spis_id = sk.ksed_spis_id
        AND ks.transakcia_zrusene_id IS NULL
    JOIN dms.vystupny_dokument vd 
        ON vd.vystupny_dokument_id = ovrd.vystupny_dokument_id
        AND vd.transakcia_zrusene_id IS NULL
    JOIN dms.dokument d 
        ON d.dokument_id = vd.vystupny_dokument_id
        AND d.transakcia_zrusene_id IS NULL
    JOIN cis.cis_typ_vystupneho_artefaktu cta 
        ON cta.cis_typ_vystupneho_artefaktu_id = vd.cis_typ_vystupneho_artefaktu_id
        AND cta.transakcia_zrusene_id IS NULL
    LEFT JOIN dms.priloha p 
        ON p.dokument_id = d.dokument_id
        AND p.transakcia_zrusene_id IS NULL
    WHERE ovr.transakcia_zrusene_id IS NULL
      AND (p_rozhodnutie_id IS NULL OR ovr.rozhodnutie_id = p_rozhodnutie_id)
    ORDER BY d.datum_vytvorenia, cta.nazov;
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_rozhodnutie_odvolanie_vyjadrenie_ucastnikov_vstupny_dok(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_rozhodnutie_odvolanie_vyjadrenie_ucastnikov_vstupny_dok(p_rozhodnutie_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, rozhodnutie_id bigint, cislo_rozhodnutia character varying, dokument_nazov text, typ_vstupneho_dokumentu text, priloha_nazov_suboru text, datum_vytvorenia text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        sk.spk_konanie_id,
        sk.cislo_konania,
        r.rozhodnutie_id,
        r.cislo_rozhodnutia,
        d.nazov,
        cta.nazov,
        p.nazov_suboru,
        TO_CHAR(d.datum_vytvorenia, 'DD.MM.YYYY')
    FROM spk.vyjadrenie_ucastnikov vu
    JOIN spk.vyjadrenie_ucastnikov_vstupny_dokument vuvd 
        ON vuvd.vyjadrenie_ucastnikov_id = vu.vyjadrenie_ucastnikov_id
        AND vuvd.vyjadrenie_ucastnikov_vstupny_dokument_id IS NOT NULL
    JOIN spk.odvolanie_voci_rozhodnutiu ovr 
        ON ovr.odvolanie_voci_rozhodnutiu_id = vu.odvolanie_voci_rozhodnutiu_id
        AND ovr.transakcia_zrusene_id IS NULL
    JOIN spk.rozhodnutie r 
        ON r.rozhodnutie_id = ovr.rozhodnutie_id
        AND r.transakcia_zrusene_id IS NULL
    JOIN spk.spk_konanie sk 
        ON sk.spk_konanie_id = r.spk_konanie_id
        AND sk.transakcia_zrusene_id IS NULL
    JOIN dms.ksed_spis ks 
        ON ks.ksed_spis_id = sk.ksed_spis_id
        AND ks.transakcia_zrusene_id IS NULL
    JOIN dms.vstupny_dokument vd 
        ON vd.vstupny_dokument_id = vuvd.vstupny_dokument_id
        AND vd.transakcia_zrusene_id IS NULL
    JOIN dms.dokument d 
        ON d.dokument_id = vd.vstupny_dokument_id
        AND d.transakcia_zrusene_id IS NULL
    JOIN cis.cis_typ_vstupneho_artefaktu cta 
        ON cta.cis_typ_vstupneho_artefaktu_id = vd.cis_typ_vstupneho_artefaktu_id
        AND cta.transakcia_zrusene_id IS NULL
    LEFT JOIN dms.priloha p 
        ON p.dokument_id = d.dokument_id
        AND p.transakcia_zrusene_id IS NULL
    WHERE 
        vu.vyjadrenie_ucastnikov_id IS NOT NULL
        AND (p_rozhodnutie_id IS NULL OR r.rozhodnutie_id = p_rozhodnutie_id)
    ORDER BY d.datum_vytvorenia, cta.nazov;
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_rozhodnutie_prerusenie_konania(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_rozhodnutie_prerusenie_konania(p_rozhodnutie_id bigint)
 RETURNS TABLE(datum_ukoncenia_preruseni text, doba_prerusenia bigint, iny_dovod_prerusenia text, prerusenie_do text, prerusenie_od text, dovod_prerusenia_kod text, dovod_prerusenia_nazov text, dovod_ukoncenia_kod text, dovod_ukoncenia_nazov text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        TO_CHAR(pk.datum_ukoncenia_preruseni, 'DD.MM.YYYY') AS datum_ukoncenia_preruseni,
        pk.doba_prerusenia,
        pk.iny_dovod_prerusenia,
        TO_CHAR(pk.prerusenie_do, 'DD.MM.YYYY') AS prerusenie_do,
        TO_CHAR(pk.prerusenie_od, 'DD.MM.YYYY') AS prerusenie_od,
        cdp.kod AS dovod_prerusenia_kod,
        cdp.nazov AS dovod_prerusenia_nazov,
        cdu.kod AS dovod_ukoncenia_kod,
        cdu.nazov AS dovod_ukoncenia_nazov
    FROM spk.prerusenie_konania pk
    LEFT JOIN cis.cis_dovod_prerusenia_konania cdp 
        ON cdp.cis_dovod_prerusenia_konania_id = pk.cis_dovod_prerusenia_id
    LEFT JOIN cis.cis_dovod_ukoncenia_prerusenia cdu 
        ON cdu.cis_dovod_ukoncenia_prerusenia_id = pk.cis_dovod_ukoncenia_id
    INNER JOIN spk.spk_konanie k 
        ON k.spk_konanie_id = pk.spk_konanie_id 
        AND k.transakcia_zrusene_id IS NULL
    WHERE 
        pk.transakcia_zrusene_id IS NULL
        AND (p_rozhodnutie_id IS NULL OR pk.rozhodnutie_id = p_rozhodnutie_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_rozhodnutie_sankcia_opatrenie_v_rozhodnuti(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_rozhodnutie_sankcia_opatrenie_v_rozhodnuti(p_rozhodnutie_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, rozhodnutie_id bigint, cislo_rozhodnutia character varying, specificky_symbol text, variabilny_symbol text, vyska_sankcie numeric, sankcia_opatrenie text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        k.spk_konanie_id,
        k.cislo_konania,
        r.rozhodnutie_id,
        r.cislo_rozhodnutia,
        sor.specificky_symbol,
        sor.variabilny_symbol,
        sor.vyska_sankcie,
        cso.nazov AS sankcia_opatrenie
    FROM spk.sankcia_opatrenie_v_rozhodnuti sor
    INNER JOIN spk.rozhodnutie r
        ON sor.rozhodnutie_id = r.rozhodnutie_id
        AND r.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON r.spk_konanie_id = k.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN cis.cis_sankcia_opatrenie cso
        ON sor.cis_sankcia_opatrenie_id = cso.cis_sankcia_opatrenie_id
        AND cso.transakcia_zrusene_id IS NULL
    WHERE sor.transakcia_zrusene_id IS NULL
      AND (p_rozhodnutie_id IS NULL OR r.rozhodnutie_id = p_rozhodnutie_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_rozhodnutie_sankcia_skutkova_podstata_v_rozhodnuti(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_rozhodnutie_sankcia_skutkova_podstata_v_rozhodnuti(p_rozhodnutie_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, rozhodnutie_id bigint, cislo_rozhodnutia character varying, zistenie text, skutkova_podstata text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        k.spk_konanie_id,
        k.cislo_konania,
        r.rozhodnutie_id,
        r.cislo_rozhodnutia,
        spvr.zistenie,
        csp.nazov AS skutkova_podstata
        --sankcia_opatrenie_v_rozhodnuti_id
    FROM spk.skutkova_podstata_v_rozhodnuti spvr
	INNER JOIN spk.sankcia_opatrenie_v_rozhodnuti sor
		ON spvr.sankcia_opatrenie_v_rozhodnuti_id = sor.sankcia_opatrenie_v_rozhodnuti_id
		AND sor.transakcia_zrusene_id IS NULL
    INNER JOIN spk.rozhodnutie r
        ON sor.rozhodnutie_id = r.rozhodnutie_id
        AND r.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON r.spk_konanie_id = k.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN cis.cis_skutkova_podstata csp
        ON spvr.cis_skutkova_podstata_id = csp.cis_skutkova_podstata_id
        AND csp.transakcia_zrusene_id IS NULL
    WHERE spvr.transakcia_zrusene_id IS NULL
      AND (p_rozhodnutie_id IS NULL OR r.rozhodnutie_id = p_rozhodnutie_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_rozhodnutie_sankcia_skutkova_podstata_v_rozhodnuti_sank(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_rozhodnutie_sankcia_skutkova_podstata_v_rozhodnuti_sank(p_rozhodnutie_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, rozhodnutie_id bigint, cislo_rozhodnutia character varying, specificky_symbol text, variabilny_symbol text, vyska_sankcie_pokuty numeric)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        k.spk_konanie_id,
        k.cislo_konania,
        r.rozhodnutie_id,
        r.cislo_rozhodnutia,
        sp.specificky_symbol,
        sp.variabilny_symbol,
        sp.vyska_sankcie_pokuty
    FROM spk.sankcia_pokuta sp
    INNER JOIN spk.skutkova_podstata_v_rozhodnuti svr
        ON sp.skutkova_podstata_v_rozhodnuti_id = svr.skutkova_podstata_v_rozhodnuti_id
        AND svr.transakcia_zrusene_id IS NULL
	INNER JOIN spk.sankcia_opatrenie_v_rozhodnuti sor
		ON svr.sankcia_opatrenie_v_rozhodnuti_id = sor.sankcia_opatrenie_v_rozhodnuti_id
		AND sor.transakcia_zrusene_id IS NULL
    INNER JOIN spk.rozhodnutie r
        ON sor.rozhodnutie_id = r.rozhodnutie_id
        AND r.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON r.spk_konanie_id = k.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    WHERE sp.transakcia_zrusene_id IS NULL
      AND (p_rozhodnutie_id IS NULL OR r.rozhodnutie_id = p_rozhodnutie_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_rozhodnutie_skutkova_podstata_v_rozhodnuti(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_rozhodnutie_skutkova_podstata_v_rozhodnuti(p_rozhodnutie_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, rozhodnutie_id bigint, cislo_rozhodnutia character varying, zistenie text, skutkova_podstata text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        k.spk_konanie_id,
        k.cislo_konania,
        r.rozhodnutie_id,
        r.cislo_rozhodnutia,
        spvr.zistenie,
        csp.nazov AS skutkova_podstata
        --sankcia_opatrenie_v_rozhodnuti_id
    FROM spk.skutkova_podstata_v_rozhodnuti spvr
    INNER JOIN spk.rozhodnutie r
        ON spvr.rozhodnutie_id = r.rozhodnutie_id
        AND r.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON r.spk_konanie_id = k.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN cis.cis_skutkova_podstata csp
        ON spvr.cis_skutkova_podstata_id = csp.cis_skutkova_podstata_id
        AND csp.transakcia_zrusene_id IS NULL
    WHERE spvr.transakcia_zrusene_id IS NULL
      AND (p_rozhodnutie_id IS NULL OR r.rozhodnutie_id = p_rozhodnutie_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_rozhodnutie_skutkova_podstata_v_rozhodnuti_sankcia_poku(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_rozhodnutie_skutkova_podstata_v_rozhodnuti_sankcia_poku(p_rozhodnutie_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, rozhodnutie_id bigint, cislo_rozhodnutia character varying, specificky_symbol text, variabilny_symbol text, vyska_sankcie_pokuty numeric)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        k.spk_konanie_id,
        k.cislo_konania,
        r.rozhodnutie_id,
        r.cislo_rozhodnutia,
        sp.specificky_symbol,
        sp.variabilny_symbol,
        sp.vyska_sankcie_pokuty
    FROM spk.sankcia_pokuta sp
    INNER JOIN spk.skutkova_podstata_v_rozhodnuti svr
        ON sp.skutkova_podstata_v_rozhodnuti_id = svr.skutkova_podstata_v_rozhodnuti_id
        AND svr.transakcia_zrusene_id IS NULL
    INNER JOIN spk.rozhodnutie r
        ON svr.rozhodnutie_id = r.rozhodnutie_id
        AND r.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON r.spk_konanie_id = k.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    WHERE sp.transakcia_zrusene_id IS NULL
      AND (p_rozhodnutie_id IS NULL OR r.rozhodnutie_id = p_rozhodnutie_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_rozhodnutie_trovy_konania(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_rozhodnutie_trovy_konania(p_rozhodnutie_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, cislo_rozhodnutia_o_trovach_konania text, datum_predpisania_trov text, vyska_trov_kod text, vyska_trov_nazov text, popis text, cislo_rozhodnutia text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT
        k.spk_konanie_id AS spk_konanie_id, 
        k.cislo_konania AS cislo_konania, 
        tk.cislo_rozhodnutia_o_trovach_konania,
        TO_CHAR(tk.datum_predpisania_trov, 'DD.MM.YYYY') AS datum_predpisania_trov,
        vt.kod AS vyska_trov_kod,
        vt.nazov AS vyska_trov_nazov,
        tk.popis,
        r.cislo_rozhodnutia::text
    FROM spk.trovy_konania tk
    INNER JOIN spk.spk_konanie k
        ON k.spk_konanie_id = tk.spk_konanie_id 
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN cis.cis_vyska_trov_konania vt
        ON vt.cis_vyska_trov_konania_id = tk.cis_vyska_trov_konania_id  
        AND vt.transakcia_zrusene_id IS NULL
    INNER JOIN spk.rozhodnutie r 
        ON r.rozhodnutie_id = tk.rozhodnutie_id 
        AND r.transakcia_zrusene_id IS NULL
    WHERE 
        tk.transakcia_zrusene_id IS NULL
        AND (p_rozhodnutie_id IS NULL OR r.rozhodnutie_id = p_rozhodnutie_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_rozhodnutie_zaloba_rozhodnutie_vystupny_dokument(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_rozhodnutie_zaloba_rozhodnutie_vystupny_dokument(p_rozhodnutie_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, rozhodnutie_id bigint, cislo_rozhodnutia character varying, dokument_nazov text, typ_vystupneho_dokumentu text, priloha_nazov_suboru text, datum_vytvorenia text, datum_podania text, poznamka text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        spk_konanie.spk_konanie_id,
        spk_konanie.cislo_konania,
        rozhodnutie.rozhodnutie_id,
        rozhodnutie.cislo_rozhodnutia,
        dokument.nazov,
        cis_typ_vystupneho_artefaktu.nazov::text,
        priloha.nazov_suboru,
        TO_CHAR(dokument.datum_vytvorenia, 'DD.MM.YYYY') AS datum_vytvorenia,
        TO_CHAR(zaloba.datum_podania, 'DD.MM.YYYY') AS datum_podania,
        zaloba.poznamka
    FROM spk.zaloba
    JOIN spk.rozhodnutie
        ON rozhodnutie.rozhodnutie_id = zaloba.rozhodnutie_id
        AND rozhodnutie.transakcia_zrusene_id IS NULL
    JOIN spk.spk_konanie
        ON spk_konanie.spk_konanie_id = rozhodnutie.spk_konanie_id
        AND spk_konanie.transakcia_zrusene_id IS NULL
    JOIN dms.ksed_spis
        ON ksed_spis.ksed_spis_id = spk_konanie.ksed_spis_id
        AND ksed_spis.transakcia_zrusene_id IS NULL
    JOIN dms.vystupny_dokument
        ON vystupny_dokument.vystupny_dokument_id = zaloba.vystupny_dokument_id
        AND vystupny_dokument.transakcia_zrusene_id IS NULL
    JOIN dms.dokument
        ON dokument.dokument_id = vystupny_dokument.vystupny_dokument_id
        AND dokument.transakcia_zrusene_id IS NULL
    JOIN cis.cis_typ_vystupneho_artefaktu
        ON cis_typ_vystupneho_artefaktu.cis_typ_vystupneho_artefaktu_id = vystupny_dokument.cis_typ_vystupneho_artefaktu_id
        AND cis_typ_vystupneho_artefaktu.transakcia_zrusene_id IS NULL
    LEFT JOIN dms.priloha
        ON priloha.dokument_id = dokument.dokument_id
        AND priloha.transakcia_zrusene_id IS NULL
    WHERE 
        zaloba.transakcia_zrusene_id IS NULL
        AND (p_rozhodnutie_id IS NULL OR rozhodnutie.rozhodnutie_id = p_rozhodnutie_id)
    ORDER BY dokument.datum_vytvorenia, cis_typ_vystupneho_artefaktu.nazov;
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_rozhodnutie_zucastneny_subjekt(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_rozhodnutie_zucastneny_subjekt(p_rozhodnutie_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, zucastneny_subjekt_nazov text, zucastneny_subjekt_rola text, zucastneny_subjekt_druh_subjektu text, adresa_typ_adresy text, adresa_obec text, adresa_ulica text, adresa_supisne_cislo text, adresa_orientacne_cislo text, adresa_psc text, adresa_stat text, adresa_subjektu text, ico text, ico_txt text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT DISTINCT
        usk.spk_konanie_id,
        usk.zucastneny_subjekt_nazov::text,
        usk.zucastneny_subjekt_rola,
        usk.zucastneny_subjekt_druh_subjektu::text,
        usk.adresa_typ_adresy::text,
        usk.adresa_obec::text,
        usk.adresa_ulica::text,
        usk.adresa_supisne_cislo::text,
        usk.adresa_orientacne_cislo::text,
        usk.adresa_psc::text,
        usk.adresa_stat::text,
        usk.adresa_subjektu::text,
        usk.ico::text,
        'IČO: ' || COALESCE(usk.ico::text, '') AS ico_txt
    FROM spk.rozhodnutie_zucastneny_subjekt rz
    JOIN artefakt.uni_zucastneny_subjekt usk
        ON rz.zucastneny_subjekt_id = usk.zucastneny_subjekt_id
    JOIN spk.rozhodnutie r
        ON r.rozhodnutie_id = rz.rozhodnutie_id
        AND r.transakcia_zrusene_id IS NULL
    WHERE rz.rozhodnutie_id = p_rozhodnutie_id;
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_ustne_pojednavanie(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_ustne_pojednavanie(p_ustne_pojednavanie_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, datum_uskutocnenia text, miestnost text, poschodie bigint, sidlo_spravneho_organu_adresa text, verejne_zhromazdenie text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        k.spk_konanie_id,
        k.cislo_konania,
        TO_CHAR(up.datum_uskutocnenia, 'DD.MM.YYYY') AS datum_uskutocnenia,
        up.miestnost,
        up.poschodie,
        up.sidlo_spravneho_organu_adresa,
        CASE WHEN up.verejne_zhromazdenie THEN 'áno' ELSE 'nie' END AS verejne_zhromazdenie
		--lokalita_id
    FROM spk.ustne_pojednavanie up
    INNER JOIN spk.zabezpecenie_konania zk
        ON up.zabezpecenie_konania_id = zk.zabezpecenie_konania_id 
        AND zk.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON k.spk_konanie_id = zk.spk_konanie_id 
        AND k.transakcia_zrusene_id IS NULL
    WHERE 
        (p_ustne_pojednavanie_id IS NULL OR up.ustne_pojednavanie_id = p_ustne_pojednavanie_id)
        AND up.transakcia_zrusene_id IS NULL;
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_ustne_pojednavanie_na_vedomie_zucastneny_subjekt(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_ustne_pojednavanie_na_vedomie_zucastneny_subjekt(p_ustne_pojednavanie_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, zucastneny_subjekt_nazov text, zucastneny_subjekt_rola text, zucastneny_subjekt_druh_subjektu text, adresa_typ_adresy text, adresa_obec text, adresa_ulica text, adresa_supisne_cislo text, adresa_orientacne_cislo text, adresa_psc text, adresa_stat text, adresa_subjektu text, ico text, ico_txt text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT DISTINCT
        k.spk_konanie_id,
        u.zucastneny_subjekt_nazov::text,
        u.zucastneny_subjekt_rola,
        u.zucastneny_subjekt_druh_subjektu::text,
        u.adresa_typ_adresy::text,
        u.adresa_obec::text,
        u.adresa_ulica::text,
        u.adresa_supisne_cislo::text,
        u.adresa_orientacne_cislo::text,
        u.adresa_psc::text,
        u.adresa_stat::text,
        u.adresa_subjektu::text,
        u.ico::text,
        'IČO: ' || COALESCE(u.ico::text, '') as ico_txt
    FROM spk.ustne_pojednavanie up
    INNER JOIN spk.zabezpecenie_konania zk
        ON up.zabezpecenie_konania_id = zk.zabezpecenie_konania_id
        AND zk.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON zk.spk_konanie_id = k.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN ksed.na_vedomie_zucastneny_subjekt nv
        ON nv.zabezpecenie_konania_id = up.zabezpecenie_konania_id
        AND nv.transakcia_zrusene_id IS NULL
    INNER JOIN artefakt.uni_zucastneny_subjekt u
        ON u.zucastneny_subjekt_id = nv.zucastneny_subjekt_id
    WHERE up.transakcia_zrusene_id IS NULL
      AND (p_ustne_pojednavanie_id IS NULL OR up.ustne_pojednavanie_id = p_ustne_pojednavanie_id)
    ORDER BY k.spk_konanie_id;
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_ustne_pojednavanie_ohliadka(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_ustne_pojednavanie_ohliadka(p_ustne_pojednavanie_id bigint)
 RETURNS TABLE(datum_oznamenia_ohliadky text, den_ohliadky_a_cas_zaciatku_ohliadky text, lokalita_opis text, katastralne_uzemie text, sidelna_jednotka text, obec text, ulica text, supisne_cislo text, orientacne_cislo text, psc text, jprl text, cislo_parcely text, adresa text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY

    -- Záznamy z ustne_pojednavanie_ohliadka
    SELECT 
        TO_CHAR(o2.datum_oznamenia_ohliadky, 'DD.MM.YYYY'),
        TO_CHAR(o2.den_ohliadky_a_cas_zaciatku_ohliadky, 'DD.MM.YYYY HH24:MI'),
        l.lokalita_opis,
        l.katastralne_uzemie,
        l.sidelna_jednotka,
        l.obec::text,
        l.ulica,
        l.supisne_cislo,
        l.orientacne_cislo,
        l.psc,
        l.jprl,
        l.cislo_parcely,
        l.adresa
    FROM spk.ustne_pojednavanie up
    INNER JOIN spk.zabezpecenie_konania zk 
        ON zk.zabezpecenie_konania_id = up.zabezpecenie_konania_id AND zk.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k 
        ON k.spk_konanie_id = zk.spk_konanie_id AND k.transakcia_zrusene_id IS NULL
    INNER JOIN spk.ustne_pojednavanie_ohliadka upo 
        ON upo.ustne_pojednavanie_id = up.ustne_pojednavanie_id
    INNER JOIN spk.ohliadka o2 
        ON o2.ohliadka_id = upo.ohliadka_id AND o2.transakcia_zrusene_id IS NULL
    LEFT JOIN artefakt.uni_lokalita l 
        ON l.lokalita_id = o2.lokalita_id
    WHERE (p_ustne_pojednavanie_id IS NULL OR up.ustne_pojednavanie_id = p_ustne_pojednavanie_id);

END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_ustne_pojednavanie_zabezpecenie_konania(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_ustne_pojednavanie_zabezpecenie_konania(p_ustne_pojednavanie_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, ustne_pojednavanie_id bigint, procesny_ukon_nazov text, procesny_ukon_popis text, znenie text, datum_zrusenia text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT
        k.spk_konanie_id,
        k.cislo_konania,
        u.ustne_pojednavanie_id,
        zk.procesny_ukon_nazov,
        zk.procesny_ukon_popis,
        zk.znenie,
        TO_CHAR(zk.datum_zrusenia, 'DD.MM.YYYY')
    FROM spk.zabezpecenie_konania zk
    INNER JOIN spk.spk_konanie k ON k.spk_konanie_id = zk.spk_konanie_id AND k.transakcia_zrusene_id IS NULL
    INNER JOIN spk.ustne_pojednavanie u ON u.zabezpecenie_konania_id = zk.zabezpecenie_konania_id AND u.transakcia_zrusene_id IS NULL
    WHERE zk.transakcia_zrusene_id IS NULL
      AND (p_ustne_pojednavanie_id IS NULL OR u.ustne_pojednavanie_id = p_ustne_pojednavanie_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_ustne_pojednavanie_zucastneny_subjekt(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_ustne_pojednavanie_zucastneny_subjekt(p_ustne_pojednavanie_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, zucastneny_subjekt_nazov text, zucastneny_subjekt_rola text, zucastneny_subjekt_druh_subjektu text, adresa_typ_adresy text, adresa_obec text, adresa_ulica text, adresa_supisne_cislo text, adresa_orientacne_cislo text, adresa_psc text, adresa_stat text, adresa_subjektu text, ico text, ico_txt text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT DISTINCT
        k.spk_konanie_id,
        u.zucastneny_subjekt_nazov::text,
        u.zucastneny_subjekt_rola,
        u.zucastneny_subjekt_druh_subjektu::text,
        u.adresa_typ_adresy::text,
        u.adresa_obec::text,
        u.adresa_ulica::text,
        u.adresa_supisne_cislo::text,
        u.adresa_orientacne_cislo::text,
        u.adresa_psc::text,
        u.adresa_stat::text,
        u.adresa_subjektu::text,
        u.ico::text,
        'IČO: ' || COALESCE(u.ico::text, '') as ico_txt
    FROM spk.ustne_pojednavanie up
    INNER JOIN spk.zabezpecenie_konania zk
        ON up.zabezpecenie_konania_id = zk.zabezpecenie_konania_id
        AND zk.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON zk.spk_konanie_id = k.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN artefakt.uni_zucastneny_subjekt u
        ON u.zucastneny_subjekt_id = zk.zucastneny_subjekt_id
    WHERE up.transakcia_zrusene_id IS NULL
      AND (p_ustne_pojednavanie_id IS NULL OR up.ustne_pojednavanie_id = p_ustne_pojednavanie_id)
    ORDER BY k.spk_konanie_id;
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_vylucenie_zamestnanca(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_vylucenie_zamestnanca(p_vylucenie_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, datum_vylucenia text, dovod_vylucenia text, vyluceny boolean, pracovnik text, org_zlozka_nazov character varying, typ_funkcie_nazov character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        k.spk_konanie_id, 
        k.cislo_konania, 
        TO_CHAR(vz.datum_vylucenia, 'DD.MM.YYYY') AS datum_vylucenia,
        vz.dovod_vylucenia,
        vz.vyluceny,
        up.pracovnik,
        up.org_zlozka_nazov,
        up.typ_funkcie_nazov
    FROM spk.vylucenie_zamestnanca vz
    INNER JOIN spk.spk_konanie k
        ON k.spk_konanie_id = vz.spk_konanie_id 
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN artefakt.uni_pracovnik up
        ON vz.pracovnik_id = up.pracovnik_id
    WHERE vz.transakcia_zrusene_id IS NULL
      AND (p_vylucenie_id IS NULL OR vz.vylucenie_zamestnanca_id = p_vylucenie_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_zabezpecenie_konania(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_zabezpecenie_konania(p_zabezpecenie_konania_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, procesny_ukon_nazov text, procesny_ukon_popis text, znenie text, datum_zrusenia text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT
        k.spk_konanie_id,
        k.cislo_konania,
        zk.procesny_ukon_nazov,
        zk.procesny_ukon_popis,
        zk.znenie,
        TO_CHAR(zk.datum_zrusenia, 'DD.MM.YYYY') AS datum_zrusenia
    FROM spk.zabezpecenie_konania zk
    INNER JOIN spk.spk_konanie k
        ON k.spk_konanie_id = zk.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    WHERE zk.transakcia_zrusene_id IS NULL
      AND (p_zabezpecenie_konania_id IS NULL OR zk.zabezpecenie_konania_id = p_zabezpecenie_konania_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_zabezpecenie_konania_doziadanie(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_zabezpecenie_konania_doziadanie(p_zabezpecenie_konania_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, doziadanie_id bigint, procesny_ukon_nazov text, procesny_ukon_popis text, znenie text, datum_zrusenia text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT
        k.spk_konanie_id,
        k.cislo_konania,
        d.doziadanie_id,
        zk.procesny_ukon_nazov,
        zk.procesny_ukon_popis,
        zk.znenie,
        TO_CHAR(zk.datum_zrusenia, 'DD.MM.YYYY')
    FROM spk.zabezpecenie_konania zk
    INNER JOIN spk.spk_konanie k 
        ON k.spk_konanie_id = zk.spk_konanie_id 
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN spk.doziadanie d 
        ON d.zabezpecenie_konania_id = zk.zabezpecenie_konania_id 
        AND d.transakcia_zrusene_id IS NULL
    WHERE zk.transakcia_zrusene_id IS NULL
      AND (p_zabezpecenie_konania_id IS NULL OR zk.zabezpecenie_konania_id = p_zabezpecenie_konania_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_zabezpecenie_konania_na_vedomie_zucastneny_subjekt(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_zabezpecenie_konania_na_vedomie_zucastneny_subjekt(p_zabezpecenie_konania_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, zucastneny_subjekt_nazov text, zucastneny_subjekt_rola text, zucastneny_subjekt_druh_subjektu text, adresa_typ_adresy text, adresa_obec text, adresa_ulica text, adresa_supisne_cislo text, adresa_orientacne_cislo text, adresa_psc text, adresa_stat text, adresa_subjektu text, ico text, ico_txt text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT DISTINCT
        k.spk_konanie_id,
        u.zucastneny_subjekt_nazov::text,
        u.zucastneny_subjekt_rola,
        u.zucastneny_subjekt_druh_subjektu::text,
        u.adresa_typ_adresy::text,
        u.adresa_obec::text,
        u.adresa_ulica::text,
        u.adresa_supisne_cislo::text,
        u.adresa_orientacne_cislo::text,
        u.adresa_psc::text,
        u.adresa_stat::text,
        u.adresa_subjektu::text,
        u.ico::text,
        'IČO: ' || COALESCE(u.ico::text, '') as ico_txt
    FROM spk.zabezpecenie_konania zk
    INNER JOIN spk.spk_konanie k
        ON zk.spk_konanie_id = k.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN ksed.na_vedomie_zucastneny_subjekt nv
        ON nv.zabezpecenie_konania_id = zk.zabezpecenie_konania_id
        AND nv.transakcia_zrusene_id IS NULL
    INNER JOIN artefakt.uni_zucastneny_subjekt u
        ON u.zucastneny_subjekt_id = nv.zucastneny_subjekt_id
    WHERE zk.transakcia_zrusene_id IS NULL
      AND (p_zabezpecenie_konania_id IS NULL OR zk.zabezpecenie_konania_id = p_zabezpecenie_konania_id)
    ORDER BY k.spk_konanie_id;
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_zabezpecenie_konania_ohliadka(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_zabezpecenie_konania_ohliadka(p_zabezpecenie_konania_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, ohliadka_id bigint, procesny_ukon_nazov text, procesny_ukon_popis text, znenie text, datum_zrusenia text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT
        k.spk_konanie_id,
        k.cislo_konania,
        o.ohliadka_id,
        zk.procesny_ukon_nazov,
        zk.procesny_ukon_popis,
        zk.znenie,
        TO_CHAR(zk.datum_zrusenia, 'DD.MM.YYYY') AS datum_zrusenia
    FROM spk.zabezpecenie_konania zk
    INNER JOIN spk.spk_konanie k
        ON k.spk_konanie_id = zk.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN spk.ohliadka o
        ON o.zabezpecenie_konania_id = zk.zabezpecenie_konania_id
        AND o.transakcia_zrusene_id IS NULL
    WHERE zk.transakcia_zrusene_id IS NULL
      AND (p_zabezpecenie_konania_id IS NULL OR zk.zabezpecenie_konania_id = p_zabezpecenie_konania_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_zabezpecenie_konania_predbezne_opatrenie(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_zabezpecenie_konania_predbezne_opatrenie(p_zabezpecenie_konania_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, predbezne_opatrenie_id bigint, procesny_ukon_nazov text, procesny_ukon_popis text, znenie text, datum_zrusenia text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT
        k.spk_konanie_id,
        k.cislo_konania,
        p.predbezne_opatrenie_id,
        zk.procesny_ukon_nazov,
        zk.procesny_ukon_popis,
        zk.znenie,
        TO_CHAR(zk.datum_zrusenia, 'DD.MM.YYYY') AS datum_zrusenia
    FROM spk.zabezpecenie_konania zk
    INNER JOIN spk.spk_konanie k
        ON k.spk_konanie_id = zk.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN spk.predbezne_opatrenie p
        ON p.zabezpecenie_konania_id = zk.zabezpecenie_konania_id
        AND p.transakcia_zrusene_id IS NULL
    WHERE zk.transakcia_zrusene_id IS NULL
      AND (p_zabezpecenie_konania_id IS NULL OR zk.zabezpecenie_konania_id = p_zabezpecenie_konania_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_zabezpecenie_konania_predvedenie(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_zabezpecenie_konania_predvedenie(p_zabezpecenie_konania_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, predvedenie_id bigint, procesny_ukon_nazov text, procesny_ukon_popis text, znenie text, datum_zrusenia text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT
        k.spk_konanie_id,
        k.cislo_konania,
        p.predvedenie_id,
        zk.procesny_ukon_nazov,
        zk.procesny_ukon_popis,
        zk.znenie,
        TO_CHAR(zk.datum_zrusenia, 'DD.MM.YYYY') AS datum_zrusenia
    FROM spk.zabezpecenie_konania zk
    INNER JOIN spk.spk_konanie k
        ON k.spk_konanie_id = zk.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN spk.predvedenie p
        ON p.zabezpecenie_konania_id = zk.zabezpecenie_konania_id
        AND p.transakcia_zrusene_id IS NULL
    WHERE zk.transakcia_zrusene_id IS NULL
      AND (p_zabezpecenie_konania_id IS NULL OR zk.zabezpecenie_konania_id = p_zabezpecenie_konania_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_zabezpecenie_konania_predvolanie(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_zabezpecenie_konania_predvolanie(p_zabezpecenie_konania_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, predvolanie_id bigint, procesny_ukon_nazov text, procesny_ukon_popis text, znenie text, datum_zrusenia text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT
        k.spk_konanie_id,
        k.cislo_konania,
        p.predvolanie_id,
        zk.procesny_ukon_nazov,
        zk.procesny_ukon_popis,
        zk.znenie,
        TO_CHAR(zk.datum_zrusenia, 'DD.MM.YYYY') AS datum_zrusenia
    FROM spk.zabezpecenie_konania zk
    INNER JOIN spk.spk_konanie k
        ON k.spk_konanie_id = zk.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN spk.predvolanie p
        ON p.zabezpecenie_konania_id = zk.zabezpecenie_konania_id
        AND p.transakcia_zrusene_id IS NULL
    WHERE zk.transakcia_zrusene_id IS NULL
      AND (p_zabezpecenie_konania_id IS NULL OR zk.zabezpecenie_konania_id = p_zabezpecenie_konania_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_zabezpecenie_konania_ustne_pojednavanie(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_zabezpecenie_konania_ustne_pojednavanie(p_zabezpecenie_konania_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, ustne_pojednavanie_id bigint, procesny_ukon_nazov text, procesny_ukon_popis text, znenie text, datum_zrusenia text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT
        k.spk_konanie_id,
        k.cislo_konania,
        u.ustne_pojednavanie_id,
        zk.procesny_ukon_nazov,
        zk.procesny_ukon_popis,
        zk.znenie,
        TO_CHAR(zk.datum_zrusenia, 'DD.MM.YYYY') AS datum_zrusenia
    FROM spk.zabezpecenie_konania zk
    INNER JOIN spk.spk_konanie k
        ON k.spk_konanie_id = zk.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN spk.ustne_pojednavanie u
        ON u.zabezpecenie_konania_id = zk.zabezpecenie_konania_id
        AND u.transakcia_zrusene_id IS NULL
    WHERE zk.transakcia_zrusene_id IS NULL
      AND (p_zabezpecenie_konania_id IS NULL OR zk.zabezpecenie_konania_id = p_zabezpecenie_konania_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_zabezpecenie_konania_zucastneny_subjekt(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_zabezpecenie_konania_zucastneny_subjekt(p_zabezpecenie_konania_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, zucastneny_subjekt_nazov text, zucastneny_subjekt_rola text, zucastneny_subjekt_druh_subjektu text, adresa_typ_adresy text, adresa_obec text, adresa_ulica text, adresa_supisne_cislo text, adresa_orientacne_cislo text, adresa_psc text, adresa_stat text, adresa_subjektu text, ico text, ico_txt text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT DISTINCT
        k.spk_konanie_id,
        u.zucastneny_subjekt_nazov::text,
        u.zucastneny_subjekt_rola,
        u.zucastneny_subjekt_druh_subjektu::text,
        u.adresa_typ_adresy::text,
        u.adresa_obec::text,
        u.adresa_ulica::text,
        u.adresa_supisne_cislo::text,
        u.adresa_orientacne_cislo::text,
        u.adresa_psc::text,
        u.adresa_stat::text,
        u.adresa_subjektu::text,
        u.ico::text,
        'IČO: ' || COALESCE(u.ico::text, '') as ico_txt
    FROM spk.zabezpecenie_konania zk
    INNER JOIN spk.spk_konanie k
        ON zk.spk_konanie_id = k.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN artefakt.uni_zucastneny_subjekt u
        ON u.zucastneny_subjekt_id = zk.zucastneny_subjekt_id
    WHERE zk.transakcia_zrusene_id IS NULL
      AND (p_zabezpecenie_konania_id IS NULL OR zk.zabezpecenie_konania_id = p_zabezpecenie_konania_id)
    ORDER BY k.spk_konanie_id;
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_zaloba_rozhodnutie(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_zaloba_rozhodnutie(p_zaloba_id bigint)
 RETURNS TABLE(cislo_rozhodnutia character varying, datum_dorucenia_rozhodnutia text, datum_pravoplatnosti text, datum_vykonatelnosti text, datum_vystavenia text, datum_zrusenia_rozhodnutia text, dorucenie_verejnou_vyhlaskou text, navrh_rozhodnutia text, popis_rozhodnutia text, poucenie text, rozhodnutie_v_ramci_obnovy_konania text, vyrok text, odovodnenie text, povolene_odvolanie text, rozhodnutie_v_odvolani text, typ_rozhodnutia_kod text, typ_rozhodnutia_nazov text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        r.cislo_rozhodnutia,
        TO_CHAR(r.datum_dorucenia_rozhodnutia, 'DD.MM.YYYY') AS datum_dorucenia_rozhodnutia,
        TO_CHAR(r.datum_pravoplatnosti, 'DD.MM.YYYY') AS datum_pravoplatnosti,
        TO_CHAR(r.datum_vykonatelnosti, 'DD.MM.YYYY') AS datum_vykonatelnosti,
        TO_CHAR(r.datum_vystavenia, 'DD.MM.YYYY') AS datum_vystavenia,
        TO_CHAR(r.datum_zrusenia_rozhodnutia, 'DD.MM.YYYY') AS datum_zrusenia_rozhodnutia,
        CASE WHEN r.dorucenie_verejnou_vyhlaskou THEN 'áno' ELSE 'nie' END AS dorucenie_verejnou_vyhlaskou,
        CASE WHEN r.navrh_rozhodnutia THEN 'áno' ELSE 'nie' END AS navrh_rozhodnutia,
        r.popis_rozhodnutia,
        r.poucenie,
        CASE WHEN r.rozhodnutie_v_ramci_obnovy_konania THEN 'áno' ELSE 'nie' END AS rozhodnutie_v_ramci_obnovy_konania,
        r.vyrok,
        r.odovodnenie,
        CASE WHEN r.povolene_odvolanie THEN 'áno' ELSE 'nie' END AS povolene_odvolanie,
        CASE WHEN r.rozhodnutie_v_odvolani THEN 'áno' ELSE 'nie' END AS rozhodnutie_v_odvolani,
        ctr.kod AS typ_rozhodnutia_kod,
        ctr.nazov AS typ_rozhodnutia_nazov
    FROM spk.zaloba z
    JOIN spk.rozhodnutie r
        ON r.rozhodnutie_id = z.rozhodnutie_id
        AND r.transakcia_zrusene_id IS NULL
    LEFT JOIN spk.spk_konanie k
        ON k.spk_konanie_id = r.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    LEFT JOIN cis.cis_typ_rozhodnutia ctr
        ON r.cis_typ_rozhodnutia_id = ctr.cis_typ_rozhodnutia_id
        AND ctr.transakcia_zrusene_id IS NULL
    WHERE z.transakcia_zrusene_id IS NULL
      AND (p_zaloba_id IS NULL OR z.zaloba_id = p_zaloba_id);
END $function$
;

-- DROP FUNCTION artefakt.lok_spk_zaloba_rozhodnutie_odvolanie(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_zaloba_rozhodnutie_odvolanie(p_zaloba_id bigint)
 RETURNS TABLE(odvolanie_voci_rozhodnutiu_id bigint, datum_pod_navrhu_na_mimo_odv_kon text, datum_pod_navrhu_na_obnovu_kon text, datum_prijatia_odvolania text, datum_rozhodnutia_o_odvolani text, datum_upovedomenia_o_odvolani text, vylucenie_odkladneho_ucinku text, cislo_rozhodnutia character varying, sposob_rozhodnutia_kod text, sposob_rozhodnutia_nazov text, typ_odvolania_kod text, typ_odvolania_nazov text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        ov.odvolanie_voci_rozhodnutiu_id,
        TO_CHAR(ov.datum_podania_navrhu_na_mimo_odvolacie_konanie, 'DD.MM.YYYY') AS datum_pod_navrhu_na_mimo_odv_kon,
        TO_CHAR(ov.datum_podania_navrhu_na_obnovu_konania, 'DD.MM.YYYY') AS datum_pod_navrhu_na_obnovu_kon,
        TO_CHAR(ov.datum_prijatia_odvolania, 'DD.MM.YYYY') AS datum_prijatia_odvolania,
        TO_CHAR(ov.datum_rozhodnutia_o_odvolani, 'DD.MM.YYYY') AS datum_rozhodnutia_o_odvolani,
        TO_CHAR(ov.datum_upovedomenia_o_odvolani, 'DD.MM.YYYY') AS datum_upovedomenia_o_odvolani,
        CASE WHEN ov.vylucenie_odkladneho_ucinku THEN 'áno' ELSE 'nie' END AS vylucenie_odkladneho_ucinku,
        r.cislo_rozhodnutia,
        csr.kod AS sposob_rozhodnutia_kod,
        csr.nazov AS sposob_rozhodnutia_nazov,
        cto.kod AS typ_odvolania_kod,
        cto.nazov AS typ_odvolania_nazov
    FROM spk.zaloba z
    JOIN spk.rozhodnutie r
        ON r.rozhodnutie_id = z.rozhodnutie_id
        AND r.transakcia_zrusene_id IS NULL
    JOIN spk.odvolanie_voci_rozhodnutiu ov
        ON ov.rozhodnutie_id = r.rozhodnutie_id
        AND ov.transakcia_zrusene_id IS NULL
    JOIN spk.spk_konanie k
        ON k.spk_konanie_id = r.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    LEFT JOIN cis.cis_sposob_rozhodnutia_v_odvolacom_konani csr
        ON ov.cis_sposob_rozhodnutia_v_odvolacom_konani_id = csr.cis_sposob_rozhodnutia_v_odvolacom_konani_id
        AND csr.transakcia_zrusene_id IS NULL
    LEFT JOIN cis.cis_typ_odvolania cto
        ON ov.cis_typ_odvolania_id = cto.cis_typ_odvolania_id
        AND cto.transakcia_zrusene_id IS NULL
    WHERE z.transakcia_zrusene_id IS NULL
      AND (p_zaloba_id IS NULL OR z.zaloba_id = p_zaloba_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_zaloba_rozhodnutie_odvolanie_voci_rozhodnutiu_vystupny(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_zaloba_rozhodnutie_odvolanie_voci_rozhodnutiu_vystupny(p_zaloba_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, rozhodnutie_id bigint, cislo_rozhodnutia text, odvolanie_voci_rozhodnutiu_id bigint, dokument_nazov text, typ_vystupneho_dokumentu_nazov text, priloha_nazov_suboru text, datum_vytvorenia_dokumentu text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        sk.spk_konanie_id,
        sk.cislo_konania,
        r.rozhodnutie_id,
        r.cislo_rozhodnutia::text,
        ovr.odvolanie_voci_rozhodnutiu_id,
        d.nazov AS dokument_nazov,
        cta.nazov::text AS typ_vystupneho_dokumentu_nazov,
        p.nazov_suboru AS priloha_nazov_suboru,
        TO_CHAR(d.datum_vytvorenia, 'DD.MM.YYYY') AS datum_vytvorenia_dokumentu
    FROM spk.zaloba z
    JOIN spk.rozhodnutie r 
        ON r.rozhodnutie_id = z.rozhodnutie_id AND r.transakcia_zrusene_id IS NULL
    JOIN spk.spk_konanie sk 
        ON sk.spk_konanie_id = r.spk_konanie_id AND sk.transakcia_zrusene_id IS NULL
    JOIN spk.odvolanie_voci_rozhodnutiu ovr 
        ON ovr.rozhodnutie_id = r.rozhodnutie_id AND ovr.transakcia_zrusene_id IS NULL
    JOIN spk.odvolanie_voci_rozhodnutiu_vystupny_dokument ovrd 
        ON ovrd.odvolanie_voci_rozhodnutiu_id = ovr.odvolanie_voci_rozhodnutiu_id AND ovrd.transakcia_zrusene_id IS NULL
    JOIN dms.vystupny_dokument vd 
        ON vd.vystupny_dokument_id = ovrd.vystupny_dokument_id AND vd.transakcia_zrusene_id IS NULL
    JOIN dms.dokument d 
        ON d.dokument_id = vd.vystupny_dokument_id AND d.transakcia_zrusene_id IS NULL
    JOIN cis.cis_typ_vystupneho_artefaktu cta 
        ON cta.cis_typ_vystupneho_artefaktu_id = vd.cis_typ_vystupneho_artefaktu_id AND cta.transakcia_zrusene_id IS NULL
    LEFT JOIN dms.priloha p 
        ON p.dokument_id = d.dokument_id AND p.transakcia_zrusene_id IS NULL
    WHERE z.transakcia_zrusene_id IS NULL
      AND (p_zaloba_id IS NULL OR z.zaloba_id = p_zaloba_id)
    ORDER BY d.datum_vytvorenia, cta.nazov;
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_zaloba_rozhodnutie_odvolanie_vstupny_dokument(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_zaloba_rozhodnutie_odvolanie_vstupny_dokument(p_zaloba_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, rozhodnutie_id bigint, cislo_rozhodnutia character varying, dokument_nazov text, typ_vstupneho_dokumentu text, priloha_nazov_suboru text, datum_vytvorenia text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        sk.spk_konanie_id,
        sk.cislo_konania,
        r.rozhodnutie_id,
        r.cislo_rozhodnutia,
        d.nazov AS dokument_nazov,
        cta.nazov AS typ_vstupneho_dokumentu,
        p.nazov_suboru AS priloha_nazov_suboru,
        TO_CHAR(d.datum_vytvorenia, 'DD.MM.YYYY') AS datum_vytvorenia
    FROM spk.zaloba z
    JOIN spk.rozhodnutie r
        ON r.rozhodnutie_id = z.rozhodnutie_id
        AND r.transakcia_zrusene_id IS NULL
    JOIN spk.odvolanie_voci_rozhodnutiu ovr
        ON ovr.rozhodnutie_id = r.rozhodnutie_id
        AND ovr.transakcia_zrusene_id IS NULL
    JOIN spk.odvolanie_voci_rozhodnutiu_vstupny_dokument ovrd 
        ON ovrd.odvolanie_voci_rozhodnutiu_id = ovr.odvolanie_voci_rozhodnutiu_id
        AND ovrd.transakcia_zrusene_id IS NULL
    JOIN spk.spk_konanie sk 
        ON sk.spk_konanie_id = r.spk_konanie_id
        AND sk.transakcia_zrusene_id IS NULL
    JOIN dms.ksed_spis ks 
        ON ks.ksed_spis_id = sk.ksed_spis_id
        AND ks.transakcia_zrusene_id IS NULL
    JOIN dms.vstupny_dokument vd 
        ON vd.vstupny_dokument_id = ovrd.vstupny_dokument_id
        AND vd.transakcia_zrusene_id IS NULL
    JOIN dms.dokument d 
        ON d.dokument_id = vd.vstupny_dokument_id
        AND d.transakcia_zrusene_id IS NULL
    JOIN cis.cis_typ_vstupneho_artefaktu cta 
        ON cta.cis_typ_vstupneho_artefaktu_id = vd.cis_typ_vstupneho_artefaktu_id
        AND cta.transakcia_zrusene_id IS NULL
    LEFT JOIN dms.priloha p 
        ON p.dokument_id = d.dokument_id
        AND p.transakcia_zrusene_id IS NULL
    WHERE z.transakcia_zrusene_id IS NULL
      AND (p_zaloba_id IS NULL OR z.zaloba_id = p_zaloba_id)
    ORDER BY d.datum_vytvorenia, cta.nazov;
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_zaloba_rozhodnutie_odvolanie_vyjadrenie_ucastnikov_vstu(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_zaloba_rozhodnutie_odvolanie_vyjadrenie_ucastnikov_vstu(p_zaloba_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, rozhodnutie_id bigint, cislo_rozhodnutia text, vyjadrenie_ucastnikov_id bigint, dokument_nazov text, typ_vstupneho_dokumentu_nazov text, priloha_nazov_suboru text, datum_vytvorenia_dokumentu text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        sk.spk_konanie_id,
        sk.cislo_konania,
        r.rozhodnutie_id,
        r.cislo_rozhodnutia::text,
        vu.vyjadrenie_ucastnikov_id,
        d.nazov AS dokument_nazov,
        cta.nazov::text AS typ_vstupneho_dokumentu_nazov,
        p.nazov_suboru AS priloha_nazov_suboru,
        TO_CHAR(d.datum_vytvorenia, 'DD.MM.YYYY') AS datum_vytvorenia_dokumentu
    FROM spk.zaloba z
    JOIN spk.rozhodnutie r 
        ON r.rozhodnutie_id = z.rozhodnutie_id AND r.transakcia_zrusene_id IS NULL
    JOIN spk.spk_konanie sk 
        ON sk.spk_konanie_id = r.spk_konanie_id AND sk.transakcia_zrusene_id IS NULL
    JOIN spk.odvolanie_voci_rozhodnutiu ovr 
        ON ovr.rozhodnutie_id = r.rozhodnutie_id AND ovr.transakcia_zrusene_id IS NULL
    JOIN spk.vyjadrenie_ucastnikov vu 
        ON vu.odvolanie_voci_rozhodnutiu_id = ovr.odvolanie_voci_rozhodnutiu_id
    JOIN spk.vyjadrenie_ucastnikov_vstupny_dokument vuvd 
        ON vuvd.vyjadrenie_ucastnikov_id = vu.vyjadrenie_ucastnikov_id
        AND vuvd.vyjadrenie_ucastnikov_vstupny_dokument_id IS NOT NULL
    JOIN dms.vstupny_dokument vd 
        ON vd.vstupny_dokument_id = vuvd.vstupny_dokument_id AND vd.transakcia_zrusene_id IS NULL
    JOIN dms.dokument d 
        ON d.dokument_id = vd.vstupny_dokument_id AND d.transakcia_zrusene_id IS NULL
    JOIN cis.cis_typ_vstupneho_artefaktu cta 
        ON cta.cis_typ_vstupneho_artefaktu_id = vd.cis_typ_vstupneho_artefaktu_id AND cta.transakcia_zrusene_id IS NULL
    LEFT JOIN dms.priloha p 
        ON p.dokument_id = d.dokument_id AND p.transakcia_zrusene_id IS NULL
    WHERE 
        z.transakcia_zrusene_id IS NULL
        AND (p_zaloba_id IS NULL OR z.zaloba_id = p_zaloba_id)
    ORDER BY d.datum_vytvorenia, cta.nazov;
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_zaloba_rozhodnutie_prerusenie_konania(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_zaloba_rozhodnutie_prerusenie_konania(p_zaloba_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(datum_ukoncenia_preruseni text, doba_prerusenia bigint, iny_dovod_prerusenia text, prerusenie_do text, prerusenie_od text, dovod_prerusenia_kod text, dovod_prerusenia_nazov text, dovod_ukoncenia_kod text, dovod_ukoncenia_nazov text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT
        TO_CHAR(pk.datum_ukoncenia_preruseni, 'DD.MM.YYYY') AS datum_ukoncenia_preruseni,
        pk.doba_prerusenia,
        pk.iny_dovod_prerusenia,
        TO_CHAR(pk.prerusenie_do, 'DD.MM.YYYY') AS prerusenie_do,
        TO_CHAR(pk.prerusenie_od, 'DD.MM.YYYY') AS prerusenie_od,
        cdp.kod AS dovod_prerusenia_kod,
        cdp.nazov AS dovod_prerusenia_nazov,
        cdu.kod AS dovod_ukoncenia_kod,
        cdu.nazov AS dovod_ukoncenia_nazov
    FROM spk.zaloba z
    JOIN spk.rozhodnutie r
        ON r.rozhodnutie_id = z.rozhodnutie_id
        AND r.transakcia_zrusene_id IS NULL
    JOIN spk.prerusenie_konania pk
        ON pk.rozhodnutie_id = r.rozhodnutie_id
        AND pk.transakcia_zrusene_id IS NULL
    LEFT JOIN cis.cis_dovod_prerusenia_konania cdp
        ON cdp.cis_dovod_prerusenia_konania_id = pk.cis_dovod_prerusenia_id
        AND cdp.transakcia_zrusene_id IS NULL
    LEFT JOIN cis.cis_dovod_ukoncenia_prerusenia cdu
        ON cdu.cis_dovod_ukoncenia_prerusenia_id = pk.cis_dovod_ukoncenia_id
        AND cdu.transakcia_zrusene_id IS NULL
    WHERE
        z.transakcia_zrusene_id IS NULL
        AND (p_zaloba_id IS NULL OR z.zaloba_id = p_zaloba_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_zaloba_rozhodnutie_sankcia_opatrenie_v_rozhodnuti(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_zaloba_rozhodnutie_sankcia_opatrenie_v_rozhodnuti(p_zaloba_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, rozhodnutie_id bigint, cislo_rozhodnutia character varying, specificky_symbol text, variabilny_symbol text, vyska_sankcie numeric, sankcia_opatrenie text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        k.spk_konanie_id,
        k.cislo_konania,
        r.rozhodnutie_id,
        r.cislo_rozhodnutia,
        sor.specificky_symbol,
        sor.variabilny_symbol,
        sor.vyska_sankcie,
        cso.nazov AS sankcia_opatrenie
    FROM spk.zaloba z
    INNER JOIN spk.rozhodnutie r
        ON r.rozhodnutie_id = z.rozhodnutie_id
        AND r.transakcia_zrusene_id IS NULL
    INNER JOIN spk.sankcia_opatrenie_v_rozhodnuti sor
        ON sor.rozhodnutie_id = r.rozhodnutie_id
        AND sor.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON r.spk_konanie_id = k.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN cis.cis_sankcia_opatrenie cso
        ON sor.cis_sankcia_opatrenie_id = cso.cis_sankcia_opatrenie_id
        AND cso.transakcia_zrusene_id IS NULL
    WHERE z.transakcia_zrusene_id IS NULL
      AND (p_zaloba_id IS NULL OR z.zaloba_id = p_zaloba_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_zaloba_rozhodnutie_sankcia_skutkova_podstata(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_zaloba_rozhodnutie_sankcia_skutkova_podstata(p_zaloba_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, rozhodnutie_id bigint, cislo_rozhodnutia character varying, zistenie text, skutkova_podstata text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        k.spk_konanie_id,
        k.cislo_konania,
        r.rozhodnutie_id,
        r.cislo_rozhodnutia,
        spvr.zistenie,
        csp.nazov AS skutkova_podstata
    FROM spk.zaloba z
    INNER JOIN spk.rozhodnutie r
        ON r.rozhodnutie_id = z.rozhodnutie_id
        AND r.transakcia_zrusene_id IS NULL
    INNER JOIN spk.sankcia_opatrenie_v_rozhodnuti sor
        ON sor.rozhodnutie_id = r.rozhodnutie_id
        AND sor.transakcia_zrusene_id IS NULL
    INNER JOIN spk.skutkova_podstata_v_rozhodnuti spvr
        ON spvr.sankcia_opatrenie_v_rozhodnuti_id = sor.sankcia_opatrenie_v_rozhodnuti_id
        AND spvr.transakcia_zrusene_id IS NULL
    INNER JOIN cis.cis_skutkova_podstata csp
        ON spvr.cis_skutkova_podstata_id = csp.cis_skutkova_podstata_id
        AND csp.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON r.spk_konanie_id = k.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    WHERE z.transakcia_zrusene_id IS NULL
      AND (p_zaloba_id IS NULL OR z.zaloba_id = p_zaloba_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_zaloba_rozhodnutie_sankcia_skutkova_podstata_sank(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_zaloba_rozhodnutie_sankcia_skutkova_podstata_sank(p_zaloba_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, rozhodnutie_id bigint, cislo_rozhodnutia character varying, specificky_symbol text, variabilny_symbol text, vyska_sankcie_pokuty numeric)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        k.spk_konanie_id,
        k.cislo_konania,
        r.rozhodnutie_id,
        r.cislo_rozhodnutia,
        sp.specificky_symbol,
        sp.variabilny_symbol,
        sp.vyska_sankcie_pokuty
    FROM spk.zaloba z
    INNER JOIN spk.rozhodnutie r
        ON r.rozhodnutie_id = z.rozhodnutie_id
        AND r.transakcia_zrusene_id IS NULL
    INNER JOIN spk.sankcia_opatrenie_v_rozhodnuti sor
        ON sor.rozhodnutie_id = r.rozhodnutie_id
        AND sor.transakcia_zrusene_id IS NULL
    INNER JOIN spk.skutkova_podstata_v_rozhodnuti svr
        ON svr.sankcia_opatrenie_v_rozhodnuti_id = sor.sankcia_opatrenie_v_rozhodnuti_id
        AND svr.transakcia_zrusene_id IS NULL
    INNER JOIN spk.sankcia_pokuta sp
        ON sp.skutkova_podstata_v_rozhodnuti_id = svr.skutkova_podstata_v_rozhodnuti_id
        AND sp.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON r.spk_konanie_id = k.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    WHERE z.transakcia_zrusene_id IS NULL
      AND (p_zaloba_id IS NULL OR z.zaloba_id = p_zaloba_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_zaloba_rozhodnutie_skutkova_podstata(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_zaloba_rozhodnutie_skutkova_podstata(p_zaloba_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, rozhodnutie_id bigint, cislo_rozhodnutia character varying, zistenie text, skutkova_podstata text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        k.spk_konanie_id,
        k.cislo_konania,
        r.rozhodnutie_id,
        r.cislo_rozhodnutia,
        spvr.zistenie,
        csp.nazov AS skutkova_podstata
    FROM spk.zaloba z
    INNER JOIN spk.rozhodnutie r
        ON z.rozhodnutie_id = r.rozhodnutie_id
        AND r.transakcia_zrusene_id IS NULL
    INNER JOIN spk.skutkova_podstata_v_rozhodnuti spvr
        ON spvr.rozhodnutie_id = r.rozhodnutie_id
        AND spvr.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON r.spk_konanie_id = k.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN cis.cis_skutkova_podstata csp
        ON spvr.cis_skutkova_podstata_id = csp.cis_skutkova_podstata_id
        AND csp.transakcia_zrusene_id IS NULL
    WHERE z.transakcia_zrusene_id IS NULL
      AND (p_zaloba_id IS NULL OR z.zaloba_id = p_zaloba_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_zaloba_rozhodnutie_skutkova_podstata_sankcia_pokuta(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_zaloba_rozhodnutie_skutkova_podstata_sankcia_pokuta(p_zaloba_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, rozhodnutie_id bigint, cislo_rozhodnutia character varying, specificky_symbol text, variabilny_symbol text, vyska_sankcie_pokuty numeric)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        k.spk_konanie_id,
        k.cislo_konania,
        r.rozhodnutie_id,
        r.cislo_rozhodnutia,
        sp.specificky_symbol,
        sp.variabilny_symbol,
        sp.vyska_sankcie_pokuty
    FROM spk.zaloba z
    INNER JOIN spk.rozhodnutie r
        ON z.rozhodnutie_id = r.rozhodnutie_id
        AND r.transakcia_zrusene_id IS NULL
    INNER JOIN spk.skutkova_podstata_v_rozhodnuti svr
        ON svr.rozhodnutie_id = r.rozhodnutie_id
        AND svr.transakcia_zrusene_id IS NULL
    INNER JOIN spk.sankcia_pokuta sp
        ON sp.skutkova_podstata_v_rozhodnuti_id = svr.skutkova_podstata_v_rozhodnuti_id
        AND sp.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON r.spk_konanie_id = k.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    WHERE z.transakcia_zrusene_id IS NULL
      AND (p_zaloba_id IS NULL OR z.zaloba_id = p_zaloba_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_zaloba_rozhodnutie_trovy_konania(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_zaloba_rozhodnutie_trovy_konania(p_zaloba_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, cislo_rozhodnutia_o_trovach_konania text, datum_predpisania_trov text, vyska_trov_kod text, vyska_trov_nazov text, popis text, cislo_rozhodnutia text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT
        k.spk_konanie_id,
        k.cislo_konania,
        tk.cislo_rozhodnutia_o_trovach_konania,
        TO_CHAR(tk.datum_predpisania_trov, 'DD.MM.YYYY') AS datum_predpisania_trov,
        vt.kod,
        vt.nazov,
        tk.popis,
        r.cislo_rozhodnutia::text
    FROM spk.zaloba z
    INNER JOIN spk.rozhodnutie r
        ON r.rozhodnutie_id = z.rozhodnutie_id
        AND r.transakcia_zrusene_id IS NULL
    INNER JOIN spk.spk_konanie k
        ON k.spk_konanie_id = r.spk_konanie_id
        AND k.transakcia_zrusene_id IS NULL
    INNER JOIN spk.trovy_konania tk
        ON r.rozhodnutie_id = tk.rozhodnutie_id 
        AND tk.transakcia_zrusene_id IS NULL
    INNER JOIN cis.cis_vyska_trov_konania vt
        ON vt.cis_vyska_trov_konania_id = tk.cis_vyska_trov_konania_id
        AND vt.transakcia_zrusene_id IS NULL
    WHERE z.transakcia_zrusene_id IS NULL
      AND (p_zaloba_id IS NULL OR z.zaloba_id = p_zaloba_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_zaloba_rozhodnutie_vystupny_dokument(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_zaloba_rozhodnutie_vystupny_dokument(p_zaloba_id bigint DEFAULT NULL::bigint)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, rozhodnutie_id bigint, cislo_rozhodnutia character varying, dokument_nazov text, typ_vystupneho_dokumentu text, priloha_nazov_suboru text, datum_vytvorenia text, datum_podania text, poznamka text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        sk.spk_konanie_id,
        sk.cislo_konania,
        r.rozhodnutie_id,
        r.cislo_rozhodnutia,
        d.nazov,
        cta.nazov::text,
        p.nazov_suboru,
        TO_CHAR(d.datum_vytvorenia, 'DD.MM.YYYY'),
        TO_CHAR(z.datum_podania, 'DD.MM.YYYY'),
        z.poznamka
    FROM spk.zaloba z
    JOIN spk.rozhodnutie r
        ON r.rozhodnutie_id = z.rozhodnutie_id
        AND r.transakcia_zrusene_id IS NULL
    JOIN spk.spk_konanie sk
        ON sk.spk_konanie_id = r.spk_konanie_id
        AND sk.transakcia_zrusene_id IS NULL
    JOIN dms.ksed_spis ks
        ON ks.ksed_spis_id = sk.ksed_spis_id
        AND ks.transakcia_zrusene_id IS NULL
    JOIN dms.vystupny_dokument vd
        ON vd.vystupny_dokument_id = z.vystupny_dokument_id
        AND vd.transakcia_zrusene_id IS NULL
    JOIN dms.dokument d
        ON d.dokument_id = vd.vystupny_dokument_id
        AND d.transakcia_zrusene_id IS NULL
    JOIN cis.cis_typ_vystupneho_artefaktu cta
        ON cta.cis_typ_vystupneho_artefaktu_id = vd.cis_typ_vystupneho_artefaktu_id
        AND cta.transakcia_zrusene_id IS NULL
    LEFT JOIN dms.priloha p
        ON p.dokument_id = d.dokument_id
        AND p.transakcia_zrusene_id IS NULL
    WHERE z.transakcia_zrusene_id IS NULL
      AND (p_zaloba_id IS NULL OR z.zaloba_id = p_zaloba_id)
    ORDER BY d.datum_vytvorenia, cta.nazov;
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_zaloba_rozhodnutie_zucastneny_subjekt(int8);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_zaloba_rozhodnutie_zucastneny_subjekt(p_zaloba_id bigint)
 RETURNS TABLE(spk_konanie_id bigint, zucastneny_subjekt_nazov text, zucastneny_subjekt_rola text, zucastneny_subjekt_druh_subjektu text, adresa_typ_adresy text, adresa_obec text, adresa_ulica text, adresa_supisne_cislo text, adresa_orientacne_cislo text, adresa_psc text, adresa_stat text, adresa_subjektu text, ico text, ico_txt text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT DISTINCT
        usk.spk_konanie_id,
        usk.zucastneny_subjekt_nazov::text,
        usk.zucastneny_subjekt_rola,
        usk.zucastneny_subjekt_druh_subjektu::text,
        usk.adresa_typ_adresy::text,
        usk.adresa_obec::text,
        usk.adresa_ulica::text,
        usk.adresa_supisne_cislo::text,
        usk.adresa_orientacne_cislo::text,
        usk.adresa_psc::text,
        usk.adresa_stat::text,
        usk.adresa_subjektu::text,
        usk.ico::text,
        'IČO: ' || COALESCE(usk.ico::text, '') AS ico_txt
    FROM spk.zaloba z
    JOIN spk.rozhodnutie r
        ON r.rozhodnutie_id = z.rozhodnutie_id
        AND r.transakcia_zrusene_id IS NULL
    JOIN spk.rozhodnutie_zucastneny_subjekt rz
        ON rz.rozhodnutie_id = r.rozhodnutie_id
    JOIN artefakt.uni_zucastneny_subjekt usk
        ON rz.zucastneny_subjekt_id = usk.zucastneny_subjekt_id
    WHERE z.transakcia_zrusene_id IS NULL
      AND (p_zaloba_id IS NULL OR z.zaloba_id = p_zaloba_id);
END;
$function$
;

-- DROP FUNCTION artefakt.lok_spk_zoznam_pracovnikov(uuid);

CREATE OR REPLACE FUNCTION artefakt.lok_spk_zoznam_pracovnikov(p_pracovnik_id uuid DEFAULT NULL::uuid)
 RETURNS TABLE(spk_konanie_id bigint, cislo_konania text, pracovnik text, org_zlozka_nazov character varying, typ_funkcie_nazov character varying)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        sk.spk_konanie_id,
        sk.cislo_konania,
        up.pracovnik,
        up.org_zlozka_nazov,
        up.typ_funkcie_nazov
    FROM 
        spk.spk_konanie sk
    INNER JOIN spk.spk_konanie_pracovnik skp ON sk.spk_konanie_id = skp.spk_konanie_id
    INNER JOIN artefakt.uni_pracovnik up ON skp.pracovnik_id = up.pracovnik_id
    WHERE 
        (p_pracovnik_id IS NULL OR up.pracovnik_id = p_pracovnik_id)
        AND sk.transakcia_zrusene_id IS NULL;
END;
$function$
;
